ppcommons
============

PayPal Common request data pieces for express middleware

It decorate the express req object with
 1. application name
 1. isInternalRequest - tells if the request is originating from internal IP
 1. showDebugInfo - tells if to show debug info (in LIVE true, if direct m/c access via siteview and bastion)
 1. rlogId - format urlencoded[base64[encrypted[pool::host]]]_hexencoded[timestamp]
 1. correlationId - unique random id for CAL - 12 bit
 1. encryptedHostName - encrypted HostName
 1. uuid - unique id - 32 bit
 1. pageStartTime - page load start time
 1. ts - decoded tracking service (analytics) cookie
 1. guidGenerator - Cross platform PayPal specific guid generator

It also dumps manifest.json in nconf with manifest namespace. To get the version information you can do `nconf.get('manifest:version')`


This should be as high as possible in the express middleware chain for PayPal Nodejs projects. This module will provide you some commonly used data pre calculated for app.

### Structure of data

```javascript

    req.appName                //current application name
    req.pageStartTime          //page load start time
    req.isInternalRequest      //if the request is originating from internal IP
    req.showDebugInfo          //if to show debug info or not.
    req.rlogId                 //rlogId for tracking and CAL
    req.uuid                   //unique id for request. Used for correlating client and server side FPTI calls.
    req.ts                     //decoded tracking service (analytics) cookie

    //also provides
    res.locals.context.pageInfo : {
        hostName : 'encrypted client host name',
        rlogId : 'rlogId'
    }
```


### How to use

1. Add the dependency in package.json and install the module

```bash
    npm install --save "commons-paypal@^1.0.0"
```

2. In your kraken app, add the middleware to `config/config.json`

```javascript
    "ppcommons": {
      "enabled": true,
      "priority": 92,
      "module": {
        "name": "commons-paypal",
        "arguments": [
          {
            "cryptKey": "vault:encrypted_rlogid_crypt_key",
            "macKey": "vault:encrypted_rlogid_mac_key"
          }
        ]
      }
    },
```

3. Use the module. As an example:

```javascript

    module.exports = function (router) {
        router.get('/', function(req, res){
            var appName = req.appName;  //added by this module
            var rlogId = req.rlogId;
            res.send('rlogId :' + rlogId);
        });
    };

```


### Catching Request scope UncaughtExceptions

 Instead of failing and restarting node process on every request level UncaughtException, now this module is wrapping `req` & `res` objects to [domain](https://nodejs.org/api/domain.html) and if app is not handling any `TypeError` or other request scope errors, it will return with 500 statusCode. In CAL, it will be logged as

 ```
 E07:09:24.99   DOMAIN  ERROR   2   stack=TypeError: Cannot read property 'partnerContextLoaded' of undefined
 ```

 Also after every 50 such unhandled occurrences, node process will be put in a graceful shutdown/restart mode.

 Based on example here - https://nodejs.org/api/domain.html#domain_explicit_binding
