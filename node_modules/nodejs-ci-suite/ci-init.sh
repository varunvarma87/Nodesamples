#!/bin/sh
#

# Initialize the Bash profile
bash_profile=$HOME/.bash_profile
if [ -f "$bash_profile" ]; then
  echo ".bash_profile exists"
else
  touch $bash_profile
fi
if [ -f "$HOME/.profile" ]; then
  echo ".profile exists"
else
  touch $HOME/.profile
fi
if [ ! -f ".bashrc" ]; then
  touch .bashrc
fi


# Get the required nodejs version using NVM
node_default_ver=v0.10.26
node_ver=$node_default_ver
if [ ! -z "$NODE_VERSION" ]; then
	node_ver=$NODE_VERSION 
fi

echo "node version: $node_ver"
# Install Node using NVM - https://github.com/creationix/nvm
curl https://raw.github.com/creationix/nvm/master/install.sh | /bin/sh

source $bash_profile
nvm install $node_ver
nvm use $node_ver
node_dir=$HOME/.nvm/$node_ver
node_exec_path=$node_dir/bin
if [ -f "$node_exec_path/node" ]; then
	echo "Successfully Installed node and npm"
	echo "node exec path - `which node`"
	echo "node version `node -v`"
	echo "npm exec path `which npm`"
	echo "npm version `npm -v`"
else
	echo "Failed to install the node version $node_ver using NVM"
	#TODO what to do if the NVM Install fails? Exit the CI Build?
	exit 1
fi

export NODE_DIR=$node_dir
echo "Move the Node binary $NODE_DIR/* to the Workspace $WORKSPACE/node"
if [ -d "$WORKSPACE/node" ]; then
	echo "Cleanup the existing node binary"
	rm -rf $WORKSPACE/node
fi
mkdir -p $WORKSPACE/node
cp -rf $NODE_DIR/. $WORKSPACE/node
node_dir=$WORKSPACE/node
node_exec_path=$node_dir/bin
export PATH=$node_exec_path:$PATH
echo " "
echo "PATH environment Var: $PATH"
echo " "
echo "node exec path - `which node`"

# Clean the node_modules
rm -rf node_modules
# Set the Python Version
npm config set python /x/opt/pp/bin/python2.7
# Set the PayPal npm registry
echo "Set the npm config registry to http://npm.paypal.com"
npm config set registry http://npm.paypal.com
# Set the Local Cache
npm config set cache $WORKSPACE/.npm
# Set the Local npm tmp
npm config set tmp $WORKSPACE/tmpnpm
# Clean NPM Cache
npm cache clean nodejs-ci-suite
# Install the CI-Suite
npm install nodejs-ci-suite@~1.0.11


CLI=$WORKSPACE/node_modules/.bin/cibuild
chmod 755 $CLI

# Generate CI-Build files
$CLI create

# Install the grunt-cli
npm install grunt-cli
