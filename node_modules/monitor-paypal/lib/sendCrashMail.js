'use strict';

var os = require('os'),
    utils = require('./utils'),
    deployEnv = require('environment-paypal'),
    nodemailer = require('nodemailer');

var smtphost,
    mailOptions = {};

module.exports.sendCrashMail = function sendCrashMail(opts) {
    // Don't send mails except in prod-like environments. Cuts down spam.
    if (deployEnv.isDev() || deployEnv.isTest()) {
        return;
    }

    smtphost = opts.smtphost || 'atom.paypalcorp.com';
    mailOptions.subject = opts.subject || "Crash email from " + os.hostname();
    mailOptions.to = opts.to;
    mailOptions.from = opts.from;
    mailOptions.text = opts.logLines;

    // create reusable transporter object using SMTP transport
    try {
        var transporter = nodemailer.createTransport({
            host: smtphost
        });

        // send mail with defined transport object
        transporter.sendMail(mailOptions, function (error, info) {
            if (error) {
                utils.writeCalEvent('sendmail', error);
            } else {
                utils.writeCalEvent('sendmail', 'msg_sent', info && info.response, 'SUCCESS');
            }
        });
    } catch (e) {
        utils.writeCalEvent('sendmail', e);
    }

};
