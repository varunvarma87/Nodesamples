'use strict';

var utils = require('./utils'),
    entrypoint = require('entrypoint-paypal'),
    debug = require('debuglog')('servicecore');

module.exports = function () {
    var cls = utils.localStorage();

    return function servicecore(req, res, next) {
        debug('middleware.');

        cls.bindEmitter(req);
        cls.bindEmitter(res);

        cls.run(function servicecoreCtx() {

            req.entrypoint = entrypoint(req.appName || 'unknown', req.path, req.header('user-agent'));

            cls.set('req', req);
            cls.set('res', res);
            cls.set('appName', req.appName || 'servicecore');
            cls.set('correlationId', req.correlationId);
            cls.set('threadId', req.threadId);
            cls.set('pageStartTime', req.pageStartTime);
            cls.set('remoteAddress', req.header('pp_remote_addr') || req.ip);
            cls.set('fn_dt', req.cookies && req.cookies.fn_dt);
            cls.set('ip', req.ip);
            cls.set('entrypoint', req.entrypoint);

            next();
        });
    };
};
