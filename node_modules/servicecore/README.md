# Overview

`servicecore` is a service invocation library that makes communicating with PayPal services easier.

### See Also

* [Changelog](https://github.paypal.com/NodeInfra/node-servicecore/blob/master/CHANGELOG.md)
* [htt:punch:](https://github.paypal.com/trlivingston/httpunch)

### Features

* Factory
* Transport
* Profiling

# Usage

### API

* `configuration` - assign to JSON object to globally configure servicecore.
* `create(name, override)` - create a client instance, configuring it with the optional `override` configuration.
* `register(name, module)` - register a new client.
* `events` - global event emitter.

### Middleware

`servicecore` middleware is used to setup the downstream client calls with the proper context for CAL profiling and logging.

If middleware is not present, profiling will not occur.

```javascript
var servicecore = require('servicecore');

servicecore.configuration = config.get('services');

app.use(servicecore());
```

**Note:** applications using `brogan` shouldn't need to do this.

### Configuration

`servicecore` can be configuration by assigning a configuration object to `servicecore.configuration`.

Example:

```json
{
    "servicecore": {
        "socketTimeout": 900
    },

    "userread": {
        "socketTimeout": 3000
    }
}
```

`servicecore` (global client defaults), client (module), and override (instance) configuration options:

* `protocol` - transport protocol (http:, https:), defaults to `https:`.
* `hostname` - service hostname, required.
* `port` - service port, optional.
* `basepath` - base path, defaults to `/`.
* `qs` - query string, if any.
* `pathparams` - provide replacements to a parameterized path variables (like '/{x}/{y}').
* `keepAlive` - use the keep alive agent, defaults to `false`.
* `maxSockets` - agent max sockets open before requests are queued, defaults to `Infinity`.
* `socketTimeout` - timeout in ms, ECONNRESET error occurs if response takes longer, defaults to `10000`.
* `connectTimeout` - connection timeout in ms, ETIMEDOUT error occurs if timeout exceeded, defaults to `200`.
* `maxRetry` - maximum connection attempts in the event of a connect timeout, defaults to `3`.
* `transport` - generic (regular http request), bridge, rest, or asf; defaults to `generic`.

Configuration also supports the following SSL specific properties:

* `rejectUnauthorized` - don't ignore SSL problems, defaults to `true`.
* `key` - ssl key string or buffer,
* `cert` - ssl cert string or buffer.
* `ca` - ssl ca cert string or buffer or array of strings / buffers.
* `passphrase` - cert passphrase string or buffer.
* `pfx` - pfx string or buffer.
* `ciphers` - open SSL cipher string. Has no affect with `asf` transport.
* `sessions` - map of sessions for ssl-resume; `false` to disable resume.

Please note, brogan will pre-populate most of these options with appropriate values.

### Create Client Instance

```javascript
var instance = servicecore.create('myclient', override);
```

This will create a client with a configuration merged from `servicecore` config, `module` config, and `override` config.

# Developer guide

The following is a guide for creating servicecore clients.

### PPaaS Configuration Client

A PPaaS configuration client is a simple configuration package that informs servicecore of the connection information for a service.

These clients have a transport type of `ppaas` and use a built-in servicecore ppaas client with the following API:

* `request(options)` - performs a request to the service by invoking transport. For options see [htt:punch:](https://github.paypal.com/NodeInfra/httpunch).

To create a PPaaS configuration client, use the [generator](https://github.paypal.com/NodeInfra/generator-ppaas-servicecore).

Some additional guidelines:

* package name <servicename> (example, userplatformserv).
* repo name node-<servicename>.
* README.md, layout.json, and package.json should be the only artifacts (other than .gitignore and .npmignore).

For an example look at [userplatformserv](https://github.paypal.com/NodeServices/node-userplatformserv).

### Client Interface

A client module is a factory function that returns an `object`.

When developing clients, the following must be true:

* `module.exports` must be a `function`.
* this function must take a `configuration` argument and a `transport` argument.
* the returned object **must not** have a property called `transport`.

The client's factory function's configuration object is merged from `servicecore` defaults, module configuration, and overrides.

For example:

```javascript
module.exports = function (config, transport) {
    return {
       doSomething: function (service, operation, callback) {
           transport({ service: service, operation: operation }, callback);
       }
   };
};
```

The `doSomething` function would then be invoked as:

```javascript
client.doSomething(something, function (error, response) {
    console.log(response.statusCode);
});
```

Clients have an additional injected getter for `transport` on the instance.

Example:

```
client.transport
```

### Invoking Transport

When invoking the `transport` function in a client, `options` specific to the transport type are passed.

**Generic**

* Uses standard http options: see [htt:punch:](https://github.paypal.com/trlivingston/httpunch) request options.

Note: if a `basepath` exists in `servicecore` configuration, then `path`, if provided, will be appended to it.

**REST**

Same as `generic` but also adds security context headers and default `accepts`  and `content-type`.

**ASF**

* `service` - the service name.
* `operation` - the operation name.
* `data` - the `application/OpenJSON` operation payload.
* `headers` - additional headers (optional).
* `correlationId` - this should only be used for *testing* purposes.

**Bridge**

* `service` - the service name.
* `operation` - the operation name.
* `data` - the `application/json` operation payload.
* `headers` - additional headers (optional).
* `correlationId` - this should only be used for *testing* purposes.

### Creating and Registering New Transports

A transport should be a factory function that returns a function. The returned function signature should take an `options` object and a `callback`.

The `callback` should take an `error` and some sort of `response` object.

Example:

```javascript
module.exports = function (config) {

    return function mytransport(options, callback) {
        //Do something
        callback(error, response);
    };

};
```

Other properties on the exports object will also be inherited into the instance of the transport passed to client.

Transports can be registered with `servicecore` through the `transport.register` function:

```javascript
servicecore.transport.register('mytransport', require('mytransport'));
```

Now, clients configured with `transport:'mytransport'` will pass `mytransport` to the invoked client function.

### Wrapping Transports

Registered transports can be wrapped with additional functionality via:

- `servicecore.transports.wrap(name, fn)` - wrap the specified transport, or all if no `name` is provided.

Arguments passed to `fn` are:

- `options` - transport invocation options (as per wrapped transport specification).
- `callback` - transport callback.
- `next` - invokes the original transport function. `options` and `callback` must be passed.

Example:

```javascript
servicecore.transports.wrap('rest', function addMyHeader(options, callback, next) {
    options.headers['myheader'] = 'hello world!';
    next(options, callback);
});
```
