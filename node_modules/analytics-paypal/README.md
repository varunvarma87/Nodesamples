analytics
=========

PayPal Analytics Module for Node.js

### Introduction

Analytics module take cares of building data for client and server side [FPTI](https://confluence.paypal.com/cnfl/display/FPTI) and siteCatalyst calls.
It binds the data to req so that **FPTI and siteCatalyst dust modules** can consume it, also this module fires a server side FPTI call.

It builds the data required for tracking calls from following sources
 1. **Buzname** - mapped to the dust template
 2. **User object** - if user is logged in
 3. **ppcommons module** - for rlogId, correlation id ...
 4. **custom app data** - app can leverage helpers and add custom analytics data for the tracking

### Dust Components
`node-analytics` module build the payload and make it available for templating languages to consume. Add these dust components in app's layout page to make client side call.
FPTI & SiteCatalyst dust components powered by bower
 - [FPTI](https://github.paypal.com/UIE-Components/px-tracking) `bower install px-tracking`
 - [Site Catalyst](https://github.paypal.com/UIE-Components/px-site-catalyst) `bower install px-site-catalyst`

### Extending Analytics

App/Controller can extend the analytics call and add custom data. Here are the few ways

1. **addError(fieldId, errorMsg, errorCode)** - Form validation errors, it's required to add the form field information which caused the error to analytics, so it can be tracked.
  - **fieldId** - is the html name or id of the field which caused the error.
  - **errorMsg** - plain text which will be shown to user
  - **errorCode** - error code associated with this error

2. **setBusinessType(businessType)** - Business type of the merchant. In case of flows where multiple parties are involved, this is the business type of the buyer. Possible values are corporation, privatecorporation, nonprofit, proprietorship, partnership and individual. Consider this use case: Buyer has a business account of type "individual" and is buying from Walmart.com where the business type is "corporation". The value of this variable should be the one of the buyer, which is "individual".

3. **setMerchantType(merchantType)** - For flows where there are more than one parties involved, the business type of the "merchant" should be recorded for FPTI in variable 'mbtp'. In the above setBusinessType scenario, the value of this variable should be the one of the merchant, which is "corporation". FPTI only requirement

4. **addData(fptiKey, siteCatalystKey, value)** - For any other custom data that app wants to track, controller can pass the fptiKey, siteCatalystKey and the value that should be tracking. Refer [FPTI Data Dictionary](http://hubworks.corp.ebay.com/Teamworks/Sites4/41616/Lists/FPTI%20Data%20Dictionary%202/AllItems.aspx)

5. **addServerSideFptiData(fptiKey, value)** - For tracking additional data through server side FPTI.

6. **flushServerSide(jsonData)** - For flushing the server side FPTI call, this will clear the additional server side fpti data after use. This is to make multiple server side fpti calls and have fine control over these calls. By default onRender analytics module will make this call.

7. **Qualifier** - App can pass qualifiers to analytics by adding `model.pageQualifier = 'someQualifier'` in controller.

8. **skipTracking** - App can disable client side analytics calls and JSON data in payload, by setting `model.skipTracking = true` in controller.

9. **getDefaultServerData** - Returns default serverside tracking payload, if you are making FPTI server side call.

10. **tsrce** - App can pass custom traffic source by adding `model.tsrce = 'my_traffic_source';`

### How to use

```javascript
    var app = express();                        //express
    var analytics = require('analytics');       //require declaration

    var aConfig = {
        ...
    }
    app.use(analytics(aConfig));                //Adding analytics in express middleware chain [brogan takes care of it]

    app.get('/', function (req, res) {
        var tracking = req.tracking;            //In case you want to track custom data and add errors, else no need
        tracking.addData('fpti_key', 's.propX', 'some value');
        tracking.addError('password', 'Wrong or invalid password', 'errorCode');

        //For server side tracking
        tracking.addServerSideFptiData(tracking.getDefaultServerData()); //Adding default server side data
        tracking.addServerSideFptiData('fpti_server_key', 'foobar');    //adding data to server side FPTI

        var model = {};
        model.abc = 'some value';
        res.render('myDustView', model);
    });
```


### Configuration

Allowed configuration

```javascript
    {
        "buznameBasePath" : "/config/buznames/",     ## This is Optional. For custom buznames. pagename_map.cdb should be available in this folder.
        "fpti" : {
            "serverUrl": "https://tracking.qa.paypal.com:8443/webapps/tracking/ts",     ## clientside FPTI Url
            "jsFullUrl": "Optional fully qualified URL of the source fpti js file"
        },
        "sitecatalyst" : {
            "jsFile" : "https://www.paypalobjects.com/js/site_catalyst/pp_jscode_080706.js"
        }
    }
```

All the other configuration is standard and analytics module will pick the right configuration based on environment.


### Server side Tracking Service

If app need to call serverside tracking with initializing analytics, use `serverTracking` API as

```js
var analytics = require('analytics-paypal');

analytics.serverTracking(data, [callback]); //JSON payload
```

### Debugging

If interested in actual payload created and sent to FPTI server side or for client side for debugging purpose, set `export DEBUG=analytics` environment variable in dev env.

