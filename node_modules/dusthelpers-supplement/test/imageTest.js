var should = require('should'),
	dust = require('dustjs-linkedin'),
	helpers = require('dustjs-helpers'),
	assert = require('assert'),
	image = require('../index');
image(dust); // register helper

// Ensure we're in the `test` environment.
process.env.NODE_ENV = 'test';

function runit(tmpl, model, callback) {
	var compiled = dust.compile(tmpl, "test");
	dust.loadSource(compiled);
	var out = dust.render("test", model, function (err, result) {
		return callback(null, result);
	});
}


// Generate global image
describe('PayPal dust helper tests', function () {
	it('global image test', function (done) {
		var tmpl = '{@link href="i/cebit.gif"/}';
		var model = {
			"context": {
				"pageInfo": {
					"hostName": "www.paypal.com"
				},
				"locality": {
					"locale": "en_US",
					"country": "US"
				}
			}
		};
		var out = runit(tmpl, model, function (err, out) {
			out.should.equal('https://www.paypalobjects.com/webstatic/i/cebit.gif');
			done();
		});
	});

	it('global image test with leading slash', function (done) {
		var tmpl = '{@link href="/i/cebit.gif"/}';
		var model = {
			"context": {
				"pageInfo": {
					"hostName": "www.paypal.com"
				},
				"locality": {
					"locale": "en_US",
					"country": "US"
				}
			}
		};
		var out = runit(tmpl, model, function (err, out) {
			out.should.equal('https://www.paypalobjects.com/webstatic/i/cebit.gif');
			done();
		});
	});


	it('global image test for stage', function (done) {
		var tmpl = '{@link href="i/cebit.gif"/}';
		var model = {
			"context": {
				"pageInfo": {
					"hostName": "www.stage2dev008.qa.paypal.com"
				},
				"locality": {
					"locale": "en_US",
					"country": "US"
				}
			}
		};
		var out = runit(tmpl, model, function (err, out) {
			out.should.equal('https://www.paypalobjects.com/webstatic/i/cebit.gif');
			done();
		});
	});


	it('global image test for localhost', function (done) {
		var tmpl = '{@link href="i/cebit.gif" /}';
		var model = {
			"context": {
				"pageInfo": {
					"hostName": "localhost.paypal.com"
				},
				"locality": {
					"host": "localhost.paypal.com",
					"locale": "en_US",
					"country": "US"
				}
			}
		};
		var out = runit(tmpl, model, function (err, out) {
			out.should.equal('https://www.paypalobjects.com/webstatic/i/cebit.gif');
			done();
		});
	});

	it('test local with no locale', function (done) {
		var tmpl = '{@link href="i/cebit.gif"/}';
		var model = {};
		var out = runit(tmpl, model, function (err, out) {
			out.should.equal('https://www.paypalobjects.com/webstatic/i/cebit.gif');
			done();
		});
	});

	it('use global to build country specific image ref', function (done) {
		var tmpl = '{@link href="de_DE/i/cebit.gif" /}';
		var model = {
			"context": {
				"pageInfo": {
					"hostName": "www.paypal.com"
				},
				"locality": {
					"locale": "en_US",
					"country": "US"
				}
			}
		};
		var out = runit(tmpl, model, function (err, out) {
			out.should.equal('https://www.paypalobjects.com/webstatic/de_DE/i/cebit.gif');
			done();
		});
	});

});
