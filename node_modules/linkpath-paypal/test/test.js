/*global describe:false, it:false*/
'use strict';

var assert = require('assert'),
    pplink = require('../index');

describe('LinkPathTest', function () {


    describe('development', function () {

        it('handle the default case', function () {
            run({
                config: {
                    host: 'localhost.paypal.com',
                    res: { req: { app: { get: function () { return '/'; } } } },
                    env: {
                        HOST_FQDN: ''
                    },
                    base: ''
                },
                expected: {
                    jsBaseUrl: '/js',
                    cssBaseUrl: '/css',
                    templateBaseUrl: '/templates',
                    resourceBaseUrl: ''
                }
            });
        });


        it('should ignore env vars', function () {
            run({
                config: {
                    host: 'localhost.paypal.com',
                    res: { req: { app: { get: function () { return '/'; }} } },
                    env: {
                        HOST_FQDN: 'stage2dev007.qa.paypal.com'
                    },
                    base: ''
                },
                expected: {
                    jsBaseUrl: '/js',
                    cssBaseUrl: '/css',
                    templateBaseUrl: '/templates',
                    resourceBaseUrl: ''
                }
            });
        });


        it('should ignore resourceBase', function () {
            run({
                config: {
                    host: 'localhost.paypal.com',
                    res: { req: { app: { get: function () { return '/'; }} } },
                    env: {
                        HOST_FQDN: ''
                    },
                    base: 'myapphashcode'
                },
                expected: {
                    jsBaseUrl: '/js',
                    cssBaseUrl: '/css',
                    templateBaseUrl: '/templates',
                    resourceBaseUrl: ''
                }
            });
        });


        it('should support application routes', function () {
            run({
                config: {
                    host: 'localhost.paypal.com',
                    res: { req: { app: { get: function () { return '/myapp';} } } },
                    env: {
                        HOST_FQDN: ''
                    },
                    base: ''
                },
                expected: {
                    jsBaseUrl: '/myapp/js',
                    cssBaseUrl: '/myapp/css',
                    templateBaseUrl: '/myapp/templates',
                    resourceBaseUrl: '/myapp'
                }
            });
        });

    });


    describe('staging', function () {

        it('should handle the default case', function () {
            run({
                config: {
                    host: 'stage2dev007.qa.paypal.com',
                    res: { req: { app: { get: function () { return '/'; }} } },
                    env: {
                        HOST_FQDN: ''
                    },
                    base: ''
                },
                expected: {
                    jsBaseUrl: '/js',
                    cssBaseUrl: '/css',
                    templateBaseUrl: '/templates',
                    resourceBaseUrl: ''
                }
            });
        });


        it('should ignore env vars', function () {
            run({
                config: {
                    host: 'stage2dev007.qa.paypal.com',
                    res: { req: { app: { get: function () { return '/'; }} } },
                    env: {
                        HOST_FQDN: 'stage2dev008.qa.paypal.com'
                    },
                    base: ''
                },
                expected: {
                    jsBaseUrl: '/js',
                    cssBaseUrl: '/css',
                    templateBaseUrl: '/templates',
                    resourceBaseUrl: ''
                }
            });
        });


        it('should ignore resourceBase', function () {
            run({
                config: {
                    host: 'stage2dev007.qa.paypal.com',
                    res: { req: { app: { get: function () { return '/'; }} } },
                    env: {
                        HOST_FQDN: ''
                    },
                    base: 'myapphashcode'
                },
                expected: {
                    jsBaseUrl: '/js',
                    cssBaseUrl: '/css',
                    templateBaseUrl: '/templates',
                    resourceBaseUrl: ''
                }
            });
        });


        it('should support application routes', function () {
            run({
                config: {
                    host: 'stage2dev007.qa.paypal.com',
                    res: { req: { app: { get: function () { return '/myapp'; } } } },
                    env: {
                        HOST_FQDN: ''
                    },
                    base: ''
                },
                expected: {
                    jsBaseUrl: '/myapp/js',
                    cssBaseUrl: '/myapp/css',
                    templateBaseUrl: '/myapp/templates',
                    resourceBaseUrl: '/myapp'
                }
            });
        });

    });


    describe('sandbox', function () {

        it('should handle the default case', function () {
            run({
                config: {
                    host: 'sandbox.paypal.com',
                    res: { req: { app: { get: function () { return '/'; }} } },
                    env: {
                        HOST_FQDN: ''
                    },
                    base: ''
                },
                expected: {
                    jsBaseUrl: 'https://sandbox.paypal.com/js',
                    cssBaseUrl: 'https://sandbox.paypal.com/css',
                    templateBaseUrl: 'https://sandbox.paypal.com/templates',
                    resourceBaseUrl: 'https://sandbox.paypal.com'
                }
            });
        });


        it('should support env vars', function () {
            run({
                config: {
                    host: 'sandbox.paypal.com',
                    res: { req: { app: { get: function () { return '/'; }} } },
                    env: {
                        HOST_FQDN: 'sandbox2.paypal.com'
                    },
                    base: ''
                },
                expected: {
                    jsBaseUrl: 'https://sandbox2.paypal.com/js',
                    cssBaseUrl: 'https://sandbox2.paypal.com/css',
                    templateBaseUrl: 'https://sandbox2.paypal.com/templates',
                    resourceBaseUrl: 'https://sandbox2.paypal.com'
                }
            });
        });


        it('should apply resourceBase', function () {
            run({
                config: {
                    host: 'sandbox.paypal.com',
                    res: { req: { app: { get: function () { return '/'; }} } },
                    env: {
                        HOST_FQDN: ''
                    },
                    base: 'myapphashcode'
                },
                expected: {
                    jsBaseUrl: 'https://sandbox.paypal.com/web/res/myapphashcode/js',
                    cssBaseUrl: 'https://sandbox.paypal.com/web/res/myapphashcode/css',
                    templateBaseUrl: 'https://sandbox.paypal.com/web/res/myapphashcode/templates',
                    resourceBaseUrl: 'https://sandbox.paypal.com/web/res/myapphashcode'
                }
            });
        });


        it('should not support application routes', function () {
            // All resources are external, so routes are meaningless.
            run({
                config: {
                    host: 'sandbox.paypal.com',
                    res: { req: { app: { get: function () { return '/myapp'; } } } },
                    env: {
                        HOST_FQDN: ''
                    },
                    base: ''
                },
                expected: {
                    jsBaseUrl: 'https://sandbox.paypal.com/js',
                    cssBaseUrl: 'https://sandbox.paypal.com/css',
                    templateBaseUrl: 'https://sandbox.paypal.com/templates',
                    resourceBaseUrl: 'https://sandbox.paypal.com'
                }
            });
        });


        it('should but support application routes and but use resourceBase', function () {
            run({
                config: {
                    host: 'sandbox.paypal.com',
                    res: { req: { app: { get: function () { return '/myapp'; } } } },
                    env: {
                        HOST_FQDN: ''
                    },
                    base: 'myapphashcode'
                },
                expected: {
                    jsBaseUrl: 'https://sandbox.paypal.com/web/res/myapphashcode/js',
                    cssBaseUrl: 'https://sandbox.paypal.com/web/res/myapphashcode/css',
                    templateBaseUrl: 'https://sandbox.paypal.com/web/res/myapphashcode/templates',
                    resourceBaseUrl: 'https://sandbox.paypal.com/web/res/myapphashcode'
                }
            });
        });


        it('should not support application routes, but use env variables and resourceBase', function () {
            run({
                config: {
                    host: 'sandbox.paypal.com',
                    res: { req: { app: { get: function () { return '/myapp'; } } } },
                    env: {
                        HOST_FQDN: 'sandbox2.paypal.com'
                    },
                    base: 'myapphashcode'
                },
                expected: {
                    jsBaseUrl: 'https://sandbox2.paypal.com/web/res/myapphashcode/js',
                    cssBaseUrl: 'https://sandbox2.paypal.com/web/res/myapphashcode/css',
                    templateBaseUrl: 'https://sandbox2.paypal.com/web/res/myapphashcode/templates',
                    resourceBaseUrl: 'https://sandbox2.paypal.com/web/res/myapphashcode'
                }
            });
        });



        it('should support configuration overrides', function () {
            var app = {
                kraken : {
                    links : {
                        base : {
                            sandbox : 'www.paypalobjects.com'
                        }
                    },
                    get: function(key) { return this[key]; }
                },
                get: function () { return '/'; }
            };
            run({
                config: {
                    host: 'sandbox.paypal.com',
                    res: { req: { app: app } },
                    env: {
                        HOST_FQDN: 'sandbox2.paypal.com'
                    },
                    base: 'myapphashcode'
                },
                expected: {
                    jsBaseUrl: 'https://www.paypalobjects.com/web/res/myapphashcode/js',
                    cssBaseUrl: 'https://www.paypalobjects.com/web/res/myapphashcode/css',
                    templateBaseUrl: 'https://www.paypalobjects.com/web/res/myapphashcode/templates',
                    resourceBaseUrl: 'https://www.paypalobjects.com/web/res/myapphashcode'
                }
            });
        });

    });


    describe('live/everything else', function () {


        it('handle the default case', function () {
            run({
                config: {
                    host: 'canbeanything.paypal.com',
                    res: { req: { app: { get: function () { return '/'; }} } },
                    env: {
                        HOST_FQDN: ''
                    },
                    base: ''
                },
                expected: {
                    jsBaseUrl: 'https://www.paypalobjects.com/js',
                    cssBaseUrl: 'https://www.paypalobjects.com/css',
                    templateBaseUrl: 'https://www.paypalobjects.com/templates',
                    resourceBaseUrl: 'https://www.paypalobjects.com'
                }
            });
        });


        it('should ignore env vars', function () {
            run({
                config: {
                    host: 'canbeanything.paypal.com',
                    res: { req: { app: { get: function () { return '/'; }} } },
                    env: {
                        HOST_FQDN: 'stage2dev007.qa.paypal.com'
                    },
                    base: ''
                },
                expected: {
                    jsBaseUrl: 'https://www.paypalobjects.com/js',
                    cssBaseUrl: 'https://www.paypalobjects.com/css',
                    templateBaseUrl: 'https://www.paypalobjects.com/templates',
                    resourceBaseUrl: 'https://www.paypalobjects.com'
                }
            });
        });


        it('should ignore overrides', function () {
            run({
                config: {
                    host: 'canbeanything.paypal.com',
                    res: {
                        req: {
                            kraken: {
                                links: {
                                    base: {
                                        live: 'somethingelse.paypal.com'
                                    }
                                }
                            },
                            app: {
                                get: function () { return '/myapp'; }
                            }
                        }
                    },
                    env: {
                        HOST_FQDN: 'stage2dev007.qa.paypal.com'
                    },
                    base: ''
                },
                expected: {
                    jsBaseUrl: 'https://www.paypalobjects.com/js',
                    cssBaseUrl: 'https://www.paypalobjects.com/css',
                    templateBaseUrl: 'https://www.paypalobjects.com/templates',
                    resourceBaseUrl: 'https://www.paypalobjects.com'
                }
            });
        });


        it('should use resourceBase', function () {
            run({
                config: {
                    host: 'canbeanything.paypal.com',
                    res: { req: { app: { get: function () { return '/'; }} } },
                    env: {
                        HOST_FQDN: ''
                    },
                    base: 'myapphashcode'
                },
                expected: {
                    jsBaseUrl: 'https://www.paypalobjects.com/web/res/myapphashcode/js',
                    cssBaseUrl: 'https://www.paypalobjects.com/web/res/myapphashcode/css',
                    templateBaseUrl: 'https://www.paypalobjects.com/web/res/myapphashcode/templates',
                    resourceBaseUrl: 'https://www.paypalobjects.com/web/res/myapphashcode'
                }
            });
        });


        it('should not support application routes', function () {
            // All resources are external, so routes are meaningless.
            run({
                config: {
                    host: 'canbeanything.paypal.com',
                    res: { req: { app: { get: function () { return '/myapp'; } } } },
                    env: {
                        HOST_FQDN: ''
                    },
                    base: ''
                },
                expected: {
                    jsBaseUrl: 'https://www.paypalobjects.com/js',
                    cssBaseUrl: 'https://www.paypalobjects.com/css',
                    templateBaseUrl: 'https://www.paypalobjects.com/templates',
                    resourceBaseUrl: 'https://www.paypalobjects.com'
                }
            });
        });

        it('should but support application routes and but use resourceBase', function () {
            run({
                config: {
                    host: 'canbeanything.paypal.com',
                    res: { req: { app: { get: function () { return '/myapp'; } } } },
                    env: {
                        HOST_FQDN: ''
                    },
                    base: 'myapphashcode'
                },
                expected: {
                    jsBaseUrl: 'https://www.paypalobjects.com/web/res/myapphashcode/js',
                    cssBaseUrl: 'https://www.paypalobjects.com/web/res/myapphashcode/css',
                    templateBaseUrl: 'https://www.paypalobjects.com/web/res/myapphashcode/templates',
                    resourceBaseUrl: 'https://www.paypalobjects.com/web/res/myapphashcode'
                }
            });
        });

    });

    it('should support environment overrides, and switch to live mode', function () {
        run({
            config: {
                host: 'canbeanything.paypal.com',
                res: {
                    req: {
                        kraken: {
                            links: {
                                env: 'live'
                            }
                        },
                        app: {
                            get: function () { return '/myapp'; }
                        }
                    }
                },
                env: {
                    HOST_FQDN: ''
                },
                base: 'myapphashcode'
            },
            expected: {
                jsBaseUrl: 'https://www.paypalobjects.com/web/res/myapphashcode/js',
                cssBaseUrl: 'https://www.paypalobjects.com/web/res/myapphashcode/css',
                templateBaseUrl: 'https://www.paypalobjects.com/web/res/myapphashcode/templates',
                resourceBaseUrl: 'https://www.paypalobjects.com/web/res/myapphashcode'
            }
        });
    });

    it('should support environment overrides, and switch development mode', function () {
        run({
            config: {
                host: 'localhost.paypal.com',
                res: {
                    req: {
                        kraken: {
                            links: {
                                env: 'development'
                            }
                        },
                        app: {
                            get: function () { return '/'; }
                        }
                    }
                },
                env: {
                    HOST_FQDN: ''
                },
                base: ''
            },
            expected: {
                jsBaseUrl: '/js',
                cssBaseUrl: '/css',
                templateBaseUrl: '/templates',
                resourceBaseUrl: ''
            }
        });
    });

});


function run(test) {
    var config, expected, result;

    config = test.config;
    expected = test.expected;

    Object.keys(config.env).forEach(function (key) {
        process.env[key] = config.env[key];
    });

    pplink.setResourceBase(config.base);
    pplink.linksBuilder(config.host, config.res);

    result = config.res.locals.context.links;
    assert.equal(result.jsBaseUrl, expected.jsBaseUrl);
    assert.equal(result.cssBaseUrl, expected.cssBaseUrl);
    assert.equal(result.templateBaseUrl, expected.templateBaseUrl);
    assert.equal(result.resourceBaseUrl, expected.resourceBaseUrl);
}
