# PayPal Logger

A request logging utility for PayPal which provides logging and profile methods per request. The module also automatically logs how long each render and end-to-end request takes.


## API

### pplogger(config)
Initializes the logger and it's configuration.

```js
pplogger({
	type: 'cal',
	format: 'cal',
	level: 'debug'
});
```
**Params**

*type* - cal, console (optional; default: console)
*format* - cal, console, JSON (optional; default: console)
*levels* - debug, info, warn, error (optional; default: debug)


## Request methods


### req.log(level, data)
Log the data for events listening to the given type, e.g. `debug`, `info`, `warn`, `error`.

```js
function (req, res, next) {
	req.log('info', 'Logging this request!');
}

```


### req.profile(function)
Log the amount of time it took for the given function to run.

```js
function (req, res, next) {
	req.profile(function () {
		// run awesome code
	});
}

```


### req.time(name [, data])
### req.timeEnd(name [, data, error, status])
A manual version of `req.profile`. This starts and stops the timer using a name value.
Pass 0|1|2 to [status][].

```js
function (req, res, next) {
	req.time('myName');
	// run awesome code
	req.timeEnd('myName')
}

```

### Root Transaction (URL)
All the http(s) requests are mapped to `URL` CAL transactions in NodeJS CAL report.
small t(`t`) marks the beginning of transaction while captial T(`T`) marks the end.

```js
t12:07:50.36    URL     request_uri
...
...
T12:07:53.34    URL     request_uri     0       2978ms      corr_id_=...&clientIP=...&log_id_=...&application_name=appName
```
App/Controller can update the payload and status code of URL CAL transaction by providing rootTxn payload in model.

```js
    app.get('/', function (req, res) {

        var model = req.model || {};
        model.rootTxn = {
            name: 'New root txn name',
            data: {
                    ...
                },
            status: 0|1|2
        };

        res.render('index', model);

    });
```

**Note:** changing rootTxn name require cal buffering.
Add the following `app.json` configuration.

```js
    "cal": {
        "enableBuffering": true
    }
```

#### status
CAL root transaction close messages may have the following status values:

 - **0** - successful processing.
 - **1** - system failure that lead to a failure in processing (e.g. remote service invocation timeout).
 - **2** - input errors that lead to failure in processing (e.g. failure in processing caused due to invalid request parameters).


### Model and session dumping
If the request url contains a query string parameter of _mode=json, the output
will be the data model that would have been used to render the view template.

If the request url contains a query string parameter of _mode=session, the output
will be the contents of the session object just before the view render would have
taken place.

Note that the output from these is in lieu of the normal output from the command and
the dumps are taken just before the view render so if the app redirects off to
somewhere else prior to rendering, these will not be effective.

### Heartbeats
pplogger is responsible of generating server and request health heartbeats for apps.
By default it logs these following heartbeats:

 - **PROCESS** - Metrics around Process
    - **pid**: process id
    - **freemem**: os available memory (in Bytes)
    - **rss**: RAM memory available to process (in Bytes)
    - **heapTotal**: total heap size of process (in Bytes)
    - **heapUsed**: heap used by process (in Bytes)
    - **os_loadavg1**: 1min average OS load
    - **os_loadavg5**: 5min average OS load
    - **os_loadavg15**: 15min average OS load
 - **REQUEST** - Metrics for Request rate
    - **mean**: overall mean request rate
    - **currentRate**: current request rate
    - **1minRate**: last 1min request rate
    - **5minRate**: last 5min request rate
    - **15minRate**: last 15min request rate
 - **CONTENT-LENGTH** - Metrics for Request payload size
    - **max**: max payload size
    - **mean**: mean payload size
    - **median**: median payload size
    - **p75**: 75th percentile payload size
    - **p95**: 95th percentile payload size
    - **p99**: 99th percentile payload size
    - **p999**: 999th percentile payload size