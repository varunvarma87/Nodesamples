'use strict';


var cal = require('cal'),
    levels = require('./levels'),
    deployEnv = require('environment-paypal');


function Logger(config) {
    config = config || {};

    var type = config.type || 'console',
        format = config.format || 'console';

    // In case of 'cal' logging type, forcing formatting to be 'cal' for proper CAL formatting
    if (type === 'cal') {
        format = 'cal';
    }

    if (deployEnv.isLive() || deployEnv.isSandbox()) {
        // forcing cal in LIVE and Sandbox always
        type = 'cal';
        format = 'cal';
        this._level = levels[config.level] || levels.info;
    }
    else {
        this._level = levels[config.level] || levels.debug;
    }

    cal.setDefaultWriteStream(type, config.settings);
    cal.defaults.formatter = cal.formatter[format];
}


Logger.prototype.debug = when(levels.debug, function debug(data) {
    var evt = cal.createEvent('LOG', 'DEBUG', cal.Status.SUCCESS);
    evt.addData(data);
    evt.complete();
});


Logger.prototype.info = when(levels.info, function info(data) {
    var evt = cal.createEvent('LOG', 'INFO', cal.Status.SUCCESS);
    evt.addData(data);
    evt.complete();
});


Logger.prototype.warn = when(levels.warn, function warn(data) {
    var evt = cal.createEvent('LOG', 'WARNING', cal.Status.WARNING);
    evt.addData(data);
    evt.complete();
});


Logger.prototype.error = when(levels.error, function error(data) {
    var evt = cal.createEvent('LOG', 'ERROR', cal.Status.ERROR);
    evt.addData(data);
    evt.complete();
});


Logger.prototype.log = Logger.prototype.debug;


module.exports = Logger;

function when(level, fn) {
    return function (data) {
        if (this._level <= level) {
            fn.call(this, data);
        }
    };
}
