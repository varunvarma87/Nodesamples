/*global describe:true, require:true, it:true */
"use strict";

var exec = require('child_process').exec,
    request = require('request'),
    path = require('path'),
    parseString = require('xml2js').parseString;

var fundingSourceGenerator = function () {
    return {
        cardGenerate: function (type, callback) {
            var creditCardPerlFile = path.join(__dirname, 'creditCard.pl');
            exec("perl " + creditCardPerlFile + " -t " + type, function (err, stdout, stderr) {
                if (!err) {
                    //remove the initial unwanted test
                    var cardNumber = stdout.replace('VISA:', '');

                    //remove any leading and trailing spaces
                    cardNumber = cardNumber.trim();

                    //console.info(cardNumber);
                    callback(null, cardNumber);
                } else {
                    //console.info (err);
                    callback('failed', err);
                }
            });
        },

        bankGenerate: function (type, callback) {
            var wrapCallback = function (callback) {
                return function (err, response, body) {
                    var bankObj = {};
                    //console.info('Body:' + body);
                    //console.info('err:' + err);
                    //console.info('response.statusCode:' + response.statusCode);
                    if (body) {
                        parseString(body, function (err, result) {
                            if (!err) {
                                //console.info(JSON.stringify(result));
                                bankObj.bankName = result.WIBankData.BankName[0];
                                bankObj.accountNum = result.WIBankData.AccountNumber[0];
                                bankObj.routingNum1 = result.WIBankData.Routing1[0];
                                //console.info('*******' + JSON.stringify(bankObj));
                                callback(null, bankObj);
                            } else {
                                callback(1, err);
                            }
                        });
                    } else {
                        callback(1, err);
                    }
                };
            };
            request.get('http://gws.corp.ebay.com/GWS/genesiswebservice.asmx/GenerateBankDetails?clientName=WebGenesis&tokenString=to5eWRF%2FpQTsxVvUEelrR1U1O1d3K00SXx5jh79up%2FfXYsgWJ9Udzw%3D%3D&countryCode=US&bankName=Tech+CU&currencyCode=USD&accountType=' + type + '&custom=false', wrapCallback(callback));
        }
    };
};

module.exports = fundingSourceGenerator;