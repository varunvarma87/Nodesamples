# Overview

Cookie parser for supporting Paypal encrypted cookies. This is not meant as a replacement for cookieParser, but rather as a supplementary middleware.
In regards to this, please declare this _after_ the express cookieParser.

# Usage

```javascript
var encryptedcookies = require('encryptedcookies'),
    CookieIds = encryptedcookies.CookieIds

server.use(encryptedcookies({
	encryptionKey: encryptionKeyFromProtectedPackage,
	macKey: macKeyFromProtectedPackage,
	decrypt: [CookieIds.WEBSCR_LOGIN_COOKIE_NAME, CookieIds.VISITOR_ID_COOKIE, CookieIds.GUID_COOKIE]
}));
```

Other configuration parameters:

`decrypt` - a list of cookies to decrypt/deserialize; defaults to `['user_session', 'visitor_id', 'guid']`.

After this middleware, encrypted cookie values will be present under their *unencrypted* names on `req.cookies`.

For example, `req.cookies.user_session`:

```javascript
{
	channel: 'WEB',
	format: 1,
	passporting: 0,
	data : {
		account_number: '2127033655768163675',
		auth_type: 80,
		login_id: '228295',
		session_number: 10,
		session_time: 1242772055
	}
}
```

# API

* `CookieIDs` - list of encrypted PayPal cookie names.

The `encryptedcookies` module also decorates the `response` object with an additional function for writing cookies:

* `encryptedCookie(name, value, options, callback)` - writes an encrypted cookie.

In addition to the typical cookie `options`, the following cookie options can be provided:

* `encryptName` - encrypts the name of the cookie as well as the value.

For example, to write an auth token as a session (new cookie format) from a `userauthserv` return's auth token:

```javascript
var encryptedcookies = require('encryptedcookies-paypal'),
    LoginCookie = require('logincookie-paypal'),
    AuthToken = require('authtoken-paypal');

AuthToken.deserialize(token, function (error, value) {
    response.encryptedCookie(encryptedcookies.CookieIds.WEBSCR_LOGIN_COOKIE_NAME, LoginCookie.serialize(new LoginCookie(value)), { secure: true, httpOnly: true, encryptName: true }, function () {
        console.log('wrote cookie');
    });
});
```

# Internal API

Encrypted names set in the `cookies` configuration list can be accessed (once the middleware has run) through `continuation-local-storage` under the namespace `encryptedcookies-paypal`.

For example:

```javascript
var cls = require('continuation-local-storage');

var visitorIdName = cls.getNamespace('encryptedcookies-paypal').get('visitor_id');
```

These properties require that the module's middleware has been run, otherwise they return null;