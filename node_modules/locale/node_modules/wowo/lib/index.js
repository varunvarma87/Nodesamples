'use strict';

var env = require('environment-paypal'),
    cdb = require('cdb'),
    fs = require('fs'),
    Wowo = require('./Wowo');

var wowo;

function init() {
    var cdbPath,
        cdbPathFound = false,
        stage = process.env.STAGE,
        deployBasePath = process.env.DEPENDENCY_ROOT;

    if (env.isDev()) {
        cdbPath = require.resolve('wowo-dev-cdbs/cdbs/wowo.cdb');
        if (fs.existsSync(cdbPath)) { // eslint-disable-line no-sync
            cdbPathFound = true;
        }
    } else {
        if (stage) {
            cdbPath = '/x/web/' + stage + '/wowo/wowo.cdb';
            if (fs.existsSync(cdbPath)) { // eslint-disable-line no-sync
                cdbPathFound = true;
            }
        }

        if (!cdbPathFound && deployBasePath) {
            cdbPath = deployBasePath + '/wowo/wowo.cdb';
            if (fs.existsSync(cdbPath)) { // eslint-disable-line no-sync
                cdbPathFound = true;
            }
        }
    }

    if (!cdbPathFound) {
        throw new Error('wowo cdb file not found.');
    }

    wowo = new Wowo(cdb.readSync(cdbPath)); // eslint-disable-line no-sync
}

function getWowo() {
    if (!wowo) {
        init();
    }

    return wowo;
}

module.exports = {
    getWowo: getWowo
};
