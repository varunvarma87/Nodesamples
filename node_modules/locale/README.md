node-locale
===========

Node module to resolve country, locale(dialect) and timeZone based on these [Resolution Rules](https://dev.paypal.com/wiki/Sparta/RequestLocaleCountryDialectResolution)

This module also provides

 - COW object for the resolved country
 - Formatter utility using [jQuery Globalize](https://github.com/jquery/globalize)

### Locale

 - If user is signed-in, by default userPref will be used to determine locale.
 - For non signed in pages, locale can be changed by passing country.x and locale.x URL params.
  `http://localhost.paypal.com:8000/NodeRefApp/home?country.x=DE&locale.x=de_DE`

 - For non signed in pages with request header x-pp-cobrand, country code can be resolved by adding x-pp-cobrand param in request header.
  `http://localhost.paypal.com:8000/<2-letter country code>/NodeRefApp/home`
   You may have to configure additional rewrite rules from your web server in order to add the 2-letter country code into your request header.

 - For testing purpose (in Non-LIVE env), you can additionally pass country.test and locale.test URL params.
  This will take precedence over userPref and is useful for testing localization in signed in pages w/o switching users.
  `http://localhost.paypal.com:8000/NodeRefApp/myaccount?country.test=DE&locale.test=de_DE`

### Locality Object

**req.locality** holds the reference of cow object and resolved country, dialect, timezone, and directionality.

 - **country** - 2 letter country code.
 - **language** - 2 letter language code.
 - **locale** - For keeping compatibility with other stacks. This will resolve to PayPal specific locale/dialect. Pass this value to services, if one is expecting.
 - **culture** - culture code for JQuery Globalize formatting (Use only to pass to globalize)

**Note:** `<country>_<language>` may not be same as `locale`. If you want to use general locale, construct using `country` and `language` instead of relying on `locale`.


```javascript
    //For server side
    //contains culture for jQuery Gloablize and Cow object reference
    req.locality = {
        country  : '2 letter country-code',
        language : '2 letter language code e.g. en, fr, es',
        locale  : '5 letter language-code e.g. en_US, en_GB, fr_FR',    //dialect in Sparta
        timezone : 'primary timezone for the country',
        culture : 'culture code for JQuery Globalize formatting',
        directionality : 'text directionality (ltr or rtl)',
        formatter : 'function which returns the formatter for current locality',
        getCountrySpecifics : 'function which hold the country specific config (currently cow) Object'
    }

    //For client side and server side
    res.locals.context.locality = {
        country  : '2 letter country-code',
        language : '2 letter language code e.g. en, fr, es',
        locale  : '5 letter language-code e.g. en_US, en_GB, fr_FR',    //dialect in Sparta
        timezone : 'primary timezone for the country',
        directionality : 'text directionality (ltr or rtl)',
    }
```

Apps can use this information from request.

```javascript
    app.get('/', function(req, res){
     var locality = req.locality; //locality object
     ...
     ...
    }
```

### Installation

1. Add following dependency in package.json
```bash
    "locale" : "0.0.x"
```

2. In express app, add
```javascript
    var locale = require('locale')
    ...
    app.use(locale());

    ...

    app.get('/', function(req, res){
        var locality = req.locality,    //req.locality - locale Object
            date = new Date(),
            culture = locality.culture,
            countrySpecifics = locality.getCountrySpecifics();      //country specific config

        var formatter = locality.formatter();  //to get formatter for current locale
        var foreignFormatter = locale.formatter(country, culture);  //to get formatter for particular country-culture

        var result = JSON.stringify(locality) +
            "<br/> " + countrySpecifics.getCurrencyCode() +
            "<br/><br/> number : " + formatter.format(1234555, "n") +
            "<br/><br/> currency : " + formatter.formatCurrency(12345.55) +
            "<br/><br/> short date : " + formatter.format(date, "d") +
            "<br/><br/> long date : " + formatter.format(date, "D") +
            "<br/><br/> parseInt : " + formatter.parseInt("12312") +
            "<br/><br/> parseFloat : " + formatter.parseFloat("1231231.1231");

        res.send(result);
    });
```


### Configuation


 - *cowBasePath* : base path to cow CDBs folder, default is './cdbs/locale/cow/'. In stage and live should point to the cow folder in locale package.
 - *lazyLoad* : true|false //if set false, it will load all the countries COW upfront. Default is on demand
 - *locales* : []    //if lazyLoad is true, you can specify the List of countries, needs to be loaded on server startup.
 - *geolocation* : true|false //Optional: default to false as many applications start with US support only and slowly ramp-up.  If set to true, it will look for a geolocation header, ak-client-info (currently provided by Akamai), and use the country info if it exists.  Akamai only appends this header if the LANG cookie is missing in the request.
 - *supportedCountries* : (optional) list of countries supported by your app, e.g. `["US", "GB", "FR"]`
 - *supportedLocales* : (optional) list of locales supported by your app, e.g. `["en-US", "en-GB", "en-FR", "fr-FR"]`
 - *countryResolvers* : (optional) priority of country resolvers, e.g. `["viaLangCookie", "viaBrowserPref", "viaGeolocation"]`
 - *dialectResolvers* : (optional) priority of dialect resolvers, e.g. `["viaLangCookie", "viaUserProfile", "viaBrowserPref"]`


lazyLoad and locales are optional and can be used to fine tune the loading of COW resources. Better keep them default to lazyload. Cost of lazyloading is very small. Maximum I noticed is 20ms for US. So ideally it should be set to lazyLoad :true

```javascript
    var localeConfig = {
        lazyLoad : true,
        locales : [
            'US',
            'GB',
            'FR'
        ],
        geolocation : false
    };
    app.use(locale(localConfig));
```

### Adding custom determiners

It's possible to add your own country and dialect determiners.

```javascript
var locale = require('locale');

locale.registerCountryDeterminer('viaUserPreference', {

    desc: 'Use the country selected by the user',

    method: function (req) {
        return req.body.country;
    }
});

locale.registerDialectDeterminer('viaUserPreference', {

    desc: 'Use the dialect selected by the user',

    method: function (req) {
        return req.body.dialect;
    }
});
```

Don't forget to add these to `countryResolvers` and `dialectResolvers` in your app.json!

## Supported Languages

List of supported languages, can be accessed as
```javascript
    console.log(locale.languages);
```

## Formatter

Node-Locale uses open source [JQuery Globalize](https://github.com/jquery/globalize) to provide formatting functionality instead of depanding on ICU data.

Formatter can be accessed in 2 ways.
 1. `req.locality.formatter()` - Returns the formatter for request's default country and culture.
 1. `locale.formatter(country, culture)` - Returns the formatter for specified country and culture.

**Formatter API**
```javascript
    format(value, format)               // takes the value and format and return the result.
    formatCurrency(value, [currency])   // format the value in formatter's currency or provided currency
    parseInt(value, [radix])            // parse integer from formatter's locale format
    parseFloat(value, [radix])          // parse float from formatter's locale format
    parseDate(value, [format])          // parse date from formatter's locale format
    getCulture()                        // returns the formatter's culture
    getCalendar()                       // returns the calendar object for the locale.

```

**Examples**

```javascript
    var formatter = locale.formatter('US', 'en-US'),        //en-US locale
        date = new Date(2013, 2, 28, 14, 10, 30);

        console.log(formatter.format(100, 'n'));            //  100.00
        console.log(formatter.format(1000, 'n'));           //  1,000.00
        console.log(formatter.formatCurrency(100));         //  $100.00
        console.log(formatter.formatCurrency(100, 'EUR'));    //  €100.00
        console.log(formatter.formatCurrency(100, 'JPY'));    //  ¥100.00
        console.log(formatter.formatCurrency(1000));        //  $1.000.00
        console.log(formatter.formatCurrency(1000.50));     //  $1.000.50
        console.log(formatter.format(date, 'd'));           //  3/28/2013
        console.log(formatter.format(date, 'f'));           //  Thursday, March 28, 2013 2:10 PM
        console.log(formatter.format(date, 'F'));           //  Thursday, March 28, 2013 2:10:30 PM
        console.log(formatter.format(date, 'D'));           //  Thursday, March 28, 2013
        console.log(formatter.format(date, 'M'));           //  March 28
        console.log(formatter.format(date, 'Y'));           //  2013 March
        console.log(formatter.format(date, 't'));           //  2:10 PM
        console.log(formatter.format(date, 'T'));           //  2:10:30 PM
        console.log(formatter.format(date, 'd MMM yyyy'));  //  28 Mar 2013
        console.log(formatter.format(date, 'd. MMMM yyyy'));//  28. March 2013
        console.log(formatter.format(date, 'MMM d, yyyy')); //  Mar 28, 2013
        console.log(formatter.parseInt('1,000'));           //  1000
        console.log(formatter.parseInt('1,000.23', 10));    //  1000
        console.log(formatter.parseFloat('1,000.23'));      //  1000.23
```

```javascript
    var formatter = locale.formatter('FR', 'fr-FR'),        //fr-FR locale
        date = new Date(2013, 2, 28, 14, 10, 30);

        console.log(formatter.format(100, 'n'));            //  100,00
        console.log(formatter.format(1000, 'n'));           //  1 000,00
        console.log(formatter.formatCurrency(100));         //  100,00 €
        console.log(formatter.formatCurrency(1000));        //  1 000,00 €
        console.log(formatter.format(date, 'd'));           //  28/03/2013
        console.log(formatter.format(date, 'f'));           //  jeudi 28 mars 2013 14:10
        console.log(formatter.format(date, 'F'));           //  jeudi 28 mars 2013 14:10:30
        console.log(formatter.format(date, 'D'));           //  jeudi 28 mars 2013
        console.log(formatter.format(date, 'M'));           //  28 mars
        console.log(formatter.format(date, 'Y'));           //  mars 2013
        console.log(formatter.format(date, 't'));           //  14:10
        console.log(formatter.format(date, 'T'));           //  14:10:30
        console.log(formatter.format(date, 'd MMM yyyy'));  //  28 mars 2013
        console.log(formatter.format(date, 'd. MMMM yyyy'));//  28. mars 2013
        console.log(formatter.format(date, 'MMM d, yyyy')); //  mars 28, 2013
        console.log(formatter.getCalendar().months.names);  //  ['janvier','février','mars','avril','mai','juin','juillet','août','septembre','octobre','novembre','décembre','']
```

For Calendar you can get the following information

```javascript
    months: {
        // full month names (12 months in general but 13 months for lunar calendars)
        names: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
        // abbreviated month names
        namesAbbr: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"]
    },
    days: {
        // full day names
        names: ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"],
        // abbreviated day names
        namesAbbr: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"],
        // shortest day names
        namesShort: ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"]
    },
    //[standard,lowercase,uppercase] designators for AM
    AM: [ "AM", "am", "AM" ],
    //[standard,lowercase,uppercase] designators for PM
    PM: [ "PM", "pm", "PM" ],
    //Date/Time Patterns
    { d: 'dd/MM/yyyy',
        D: 'dd MMMM yyyy',
        t: 'HH:mm',
        T: 'HH:mm:ss',
        f: 'dd MMMM yyyy HH:mm',
        F: 'dd MMMM yyyy HH:mm:ss',
        M: 'dd MMMM',
        Y: 'MMMM yyyy',
        S: 'yyyy\'-\'MM\'-\'dd\'T\'HH\':\'mm\':\'ss'
    }
```
