node-topos
==========

Topos module for Node.js. This module resolves the connection end points for paypal internal services.

- LIVE
    - topo package
- Stage
    - topo package only
    - topo package + stage override
- DEV
    - stage host + topo.main and portmap.topo from https://github.paypal.com/Topology/topo

### Internals

LayoutJSON aggregator will be part of npm postinstall, which will scan for all the layout.json files and aggregate them to final layout.json

- Environment specific step
    - For dev, uses topo:host (from config) + layout.json + topoMain.topo + PORTMAP.topo to generate the in memory layout.json
    - For stage and live, run configurator on this layout.json and generate final layout.json.
        - configurator take layout template file and service connection manifest file as input and output is layout.json. Full flow is layout_temp.json + service_manifest.json -> configurator -> layout.json

- Uses nconf to store this layout.json as well. nconf acts as serviceLocator

### For NodeApp developers

#### To integrate topo functionality in your node app, follow these steps

- Add topo dependency in package.json

```javascript
    "dependencies" : {
        "topos" : "~0.2.0"
    }
```
- Run npm install
- If you are using not using brogan, Add the following code in index.js of KrakenJS Node app

The module (brogan)[https://github.paypal.com/NodeInfra/brogan] takes care of the below code for your app automatically. If you are not using brogan, add the follwing code.


```javascript
var topos = require('topos');

app.configure = function (nconf, next) {

    topos.init(nconf.get('topos'), nconf);

    ...
    next(null, nconf);
};
```

#### Devlopment Environment Overrides

- By default topos package will resolve all the services for dev env from live.qa.paypal.com, but you can override this in development.json as

```javascript
{
    "topos" : {
        "host" : "stage2lp37.qa.paypal.com"
    }
}
```

#### Stage Environment Overrides

- You can extend this topos:host (by moving the above config in config.json or staging.json) in stages as well and point to one specific stage for all your services. By this you can have your node app running in stageXXX and all the services in stageYYY.

This override will be completely Ignored in LIVE.


#### How to define Service specific End points?

##### Example 1: What if you would want to connect to StageABC for service ABC and StageDEF for service DEF and connect to managed stage "live.qa.paypal.com" for all the rest of the services.

Use the Enviornment specific config files for service level overrides.

For example edit `development.json` for dev ENV and `staging.json` for Stage.

```javascript
{
    "services" : {
        "ABC" : {
            "hostname : "stageABC.qa.paypal.com"
        },
        "DEF" : {
            "hostname" : "stageDEF.qa.paypal.com"
        }
    }
}
```

##### Example 2: Let's say I want to override mayfly end point to test some new feature and stage2dev005.qa.paypal.com has these new changes.

 -  Copy the configuration from node_modules/connect-mayfly/node_modules/mayfly/layout.json (Mayfly dependency path) to staging.json.
 - Hardcode '"ipport" : "%{mayfly-session_service}"' to '"ipport" : "1:stage2dev005.qa.paypal.com:10368"'
 - Now on restart, mayfly will point to stage2dev005 while all the other services (using topo) will point to the default stage (live.qa.paypal.com).

```javascript
{
    "mayfly": {
        "ipport": "1:stage2dev005.qa.paypal.com:10368"
    }
}
```

##### Example 3: What if you would want to connect to StageABC for service ABC and connect to "stage2dev005.qa.paypal.com" for all the rest of the services (not managed stage).

Add the follwing sections to the ENV specific config file (Lets say `satging.json`):


```javascript
{
    "services" : {
        "ABC" : {
            "hostname : "stageABC.qa.paypal.com"
        }
    }
}
```

```javascript
{
    "topos" : {
        "host" : "stage2dev005.qa.paypal.com"
    }
}
```

#### How to check the details of the Resolved Endpoints?

- You can also check the resolved topo endpoints in your app by

```javascript
console.log(topos.getDump());
```

#### How to check the status of the Resolved Endpoint connections (Dev and Stage)

- You can check the status of topo connections

```javascript
topos.connectionStatus(function(err, data){
    console.log(data);
});
```

By default, topo module will run the connection check against all the topo service endpoints in dev and stage.

##### Disable connection check
- By default topos will run the connection check in dev environment, but for some reason if you don't want it, you can disable it by adding the following configuration.

```javascript
{
    "topos" : {
        "connectionCheck": "disable"
    }
}
```


### For module authors

If your module depends on TOPO, you need to create a layout.json file at the same level as package.json

something like

```javascript
mymodule
    |...
    |...
    |__ index.js
    |
    |__ layout.json  ## This file
    |
    |__ package.json
```

- If you are using the `Service Core` Module as the service invocation library, `Servicecore` module will read your module configurations from either the layout.json or the config files based on the environment. Please make sure that you are registering/creating the Service core instance uisng th exact same name as your module.


Else, Have a peerDependency on nconf and get the module topo configuration directly from nconf inside your module.

```javascript
    var nconfig = nconf.get('mymodule');
    ...
```

#### Example

##### format with root

This is useful to group layouts under one root.

```javascript
layout.json (mymodule)
{
    "root": "services",
    "layout": {
        "host": "%{mymodule_serv_host}",
        "port": "%{mymodule_serv_port}"
    }
}
```

```javascript
    servicecore.register('mymodule', require('mymodule'));


    servicecore.create('mymodule', {  });
```

OR

```javascript
var nconf = require('nconf');   //peerDependency

function MyModule(config) {

    ...

    var nconfig = nconf.get('services:mymodule');        //comes from layout.json or config overrides, 'mymodule' is the name in package.json and 'services' is the root
    console.log(nconfig.host, nconfig.port);
}
```

##### simple format

```javascript
layout.json (mymodule)
{
    "host" : "%{mymodule_serv_host}",
    "port" : "%{mymodule_serv_port}"
}
```

```javascript
var nconf = require('nconf');    //peerDependency

function MyModule(config) {

    ...

    var nconfig = nconf.get('mymodule');        //comes from layout.json or config overrides, 'mymodule' is the name in package.json
    console.log(nconfig.host, nconfig.port);
}
```

##### ipport format

If service endpoint is following the netstring format `<priority>:<qualified host name or ip>:<port>[^<priority>:<qualified host name or ip>:<port>]`, use `ipport` in layout.json to express it. Topo module will normalize it to host/hostname and port.

```javascript
layout.json (mymodule)
{
    "ipport" : "%{mymodule_serv}"
}
```

```javascript
var nconf = require('nconf');    //peerDependency

function MyModule(config) {

    ...

    var nconfig = nconf.get('mymodule');        //comes from layout.json, 'mymodule' is the name in package.json
    console.log(nconfig.host, nconfig.port);
}
```

##### url format

If service has direct url, use `url` in layout.json to express it. Topo module will normalize it to host/hostname and port.

```javascript
layout.json (mymodule)
{
    "url" : "%{mymodule_serv_url}"
}
```


### PortMap

Since topo module maintain a map of all the service-ports in STAGE environment. You can access it as

```js
    topos.getAllEndPoints()             //Map of all service-ports
    topos.getPort(serviceName)          //return the stage2 port for a service
```
