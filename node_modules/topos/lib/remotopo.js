'use strict';

var async = require('async'),
    curlnsave = require('curlnsave'),
    biblio = require('./bibliography'),
    topomain = require('./topomain');


function read(callback) {
    var curl, tasks;

    curl = curlnsave.create({ outdir: biblio.dir.topos });
    tasks = [

        function (next) {
            curl.fetch(biblio.url.topo.main, next);
        },

        function (next) {
            curl.fetch(biblio.url.topo.stageEnv, next);
        },

        function (next) {
            curl.fetch(biblio.url.topo.stage2Env, next);
        }

    ];

    async.parallel(tasks, callback);
}


function parse(callback) {
    var error;
    try {
        topomain.parsePorts();
    } catch (err) {
        error = err;
    } finally {
        callback(error);
    }
}


exports.load = function (callback) {
    async.series([ read, parse ], callback);
};