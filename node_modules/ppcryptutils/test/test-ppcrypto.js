/*global describe:false, before:false, it:false*/
'use strict';

var PPCrypto = require('../lib/ppcrypto'),
    Base64 = require('../lib/base64/b64wrap'),
    assert = require('chai').assert;

//Base64.CharacterSet = {
//    DEFAULT      : 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/',
//    PPBASE64     : 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-.',
//    URLSAFE      : 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_',
//    PPUUENCODING : '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz_-'
//};

describe('PPCrypto', function () {

    var cookieStruct = new Buffer([91, -91, 92, 37, -41, -67, -124, 29, -57, 123, 3, 0, 0, 0, 0, 0, 10, 0, 0, 0, 87, 50, 19, 74, 0, 0, 80, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]);

    var encryptTestCookie = 'KIed4ZuzuUaptYM7aPu7v7Y-CwoKuJ3_TkcpcYVV0zH0yHCzFkTqnsHMLTKuSgtDHOHQhRSkLF8xs0866ucpGrVgimUGFW7yB66EfG5HxBKrIpDYJ9L0d0COWl_O4xoUwP7Q20';

    var configuration = {
        encryptionAlgorithm: 'desx',
        macAlgorithm: 'sha1',
        encryptionKey: new Buffer('1h1P/y6F/kg6OlM7oeTms2Yr6Lw=', 'base64'),
        macKey: new Buffer('SF4HNI/A1U3xPww2eylPqJNQIvU=', 'base64')
    };
    var configuration_aes = {
        encryptionAlgorithm: 'aes-128-cbc',
        macAlgorithm: 'sha1',
        encryptionKey: new Buffer('1h1P/y6F/kg6OlM7oeTmsw==', 'base64'),
        //encryptionKey : new Buffer('1h1P/y6F/kg6OlM7oeTms2Yr6Lw=','base64'),
        macKey: new Buffer('YWJjZGVmZ2hpamtsbW5vcA==', 'base64')
        //macKey : new Buffer('SF4HNI/A1U3xPww2eylPqJNQIvU=','base64')
    };

    before(function (next) {
        next();
    });

    it('should seal Hello World', function (next) {

        var ppcrypto = new PPCrypto(configuration);

        ppcrypto.sealAndEncode(new Buffer('Hello World'), function (data) {
            assert.strictEqual(data, 'EeID2labT1Xskqv5sMSXtAGUMDzrt1eljVgdzU5PTlCwKloaAodwdQDqfzW');
            next();
        });

    });

    it('should unseal Hello World', function (next) {

        var ppcrypto = new PPCrypto(configuration);

        ppcrypto.decodeAndUnseal(new Buffer('EeID2labT1Xskqv5sMSXtAGUMDzrt1eljVgdzU5PTlCwKloaAodwdQDqfzW'), function (data) {
            assert.strictEqual(data.toString(), 'Hello World');
            next();
        });

    });

    it('should seal cookie', function (next) {

        var ppcrypto = new PPCrypto(configuration);

        ppcrypto.sealAndEncodeNamed('user_session', cookieStruct, function (data) {
            assert.strictEqual(data, encryptTestCookie);
            next();
        });

    });

    it('should unseal cookie', function (next) {

        var ppcrypto = new PPCrypto(configuration);

        ppcrypto.decodeAndUnsealNamed('user_session', new Buffer(encryptTestCookie), function (data) {
            assert.strictEqual(data.toString('hex'), cookieStruct.toString('hex'));
            next();
        });

    });

    it('should hmac the name', function (next) {

        var ppcrypto = new PPCrypto(configuration);

        var hmac = ppcrypto.hmacString('user_session');

        assert.strictEqual(hmac, 'TVKbnJIgoopqCTftP3PCeQTrLnu');

        next();
    });

    /**
     * This does both because it encrypts one way - i.e. you can't check it except to unseal it.
     */
    it('should encrypt/decrypt rlogid', function (next) {

        var inputValue = 'nodejstestweb::lm-sjn-00713581';

        var base64 = new Base64({ characterSet: Base64.CharacterSet.PPBASE64 });

        var ppcrypto = new PPCrypto({
            encryptionAlgorithm: 'des-ede3-cbc',
            macAlgorithm: 'sha1',
            encryptionKey: new Buffer('mjok7Ye1bVDHkCDMQZUvZ8VhkawCvhoM', 'base64'),
            macKey: base64.decode('8rH6RMptN2O3kH4YwJQFyA-owRM')
        });

        ppcrypto.macKeyStringXorEncryptAndEncode(new Buffer(inputValue), function (result) {
            ppcrypto.macKeyStringXorDecryptAndDecode(result, function (original) {
                assert.strictEqual(original, inputValue);
                next();
            });
        });
    });

    it('should decrypt rlogid encrypted in Java', function (next) {

        var inputValue = 'marketingspartaweb::slcspartamp3027a';
        var expectedValue = 'pgPczdYpBs23BkNh0ThnaJai4PgoWJQdT25CqhYbXNOaICZctMfMmjsoz6LGMk8/lR9+oqbLjOpmjs0lsXO80A';

        var base64 = new Base64({ characterSet: Base64.CharacterSet.PPBASE64 });

        var ppcrypto = new PPCrypto({
            encryptionAlgorithm: 'des-ede3-cbc',
            macAlgorithm: 'sha1',
            encryptionKey: new Buffer('mjok7Ye1bVDHkCDMQZUvZ8VhkawCvhoM', 'base64'),
            macKey: new Buffer('8rH6RMptN2O3kH4YwJQFyA-owRM', 'base64')
        });

        ppcrypto.macKeyStringXorDecryptAndDecode(expectedValue, function (result) {
            assert.strictEqual(result, inputValue);
            next();
        });
    });

    it('should encrypt-decrypt des-cbc', function (next) {

        var inputValue = '_PayPal_';

        var base64 = new Base64({ characterSet: Base64.CharacterSet.PPBASE64 });

        var ppcrypto = new PPCrypto({
            encryptionAlgorithm: 'des-cbc',
            macAlgorithm: 'sha1',
            encryptionKey: new Buffer('01254567', 'utf8'),
            macKey: new Buffer('0125456789abcdefghijX', 'utf8')
        });

        var descbc = ppcrypto.createCipherSpec();
        descbc.cipher(inputValue, function (encryptedDataBuffer) {
            descbc.decipher(encryptedDataBuffer, function (originalValue) {
                assert.ok(inputValue === originalValue.toString());
                next();
            });
        }.bind(this));
    });

    it('should encrypt-decrypt aes-256-cbc', function (next) {

        var inputValue = 'Test';

        var ppcrypto = new PPCrypto({
            encryptionAlgorithm: 'aes-256-cbc',
            encryptionKey: new Buffer(32),
            padding: true
        });

        var aes256 = ppcrypto.createCipherSpec();

        aes256.cipher(inputValue, function (encryptedDataBuffer) {
            aes256.decipher(encryptedDataBuffer, function (originalValue) {
                assert.ok(inputValue === originalValue.toString());
                next();
            });
        }.bind(this));

    });

    /*
    it('should encrypt-decrypt fiid', function (next) {

        var inputValue = 'CCJT6QKAL638F9L';

        var ppcrypto = new PPCrypto({
            encryptionAlgorithm: 'aes-256-cbc',
            encryptionKey: new Buffer(32),
            padding: true
        });

        ppcrypto.encryptFiid(inputValue, function (encrypted) {
            assert.strictEqual(encrypted.slice(0,2).toString(),'CC');
            ppcrypto.decryptFiid(encrypted, function (decrypted) {
                assert.strictEqual(inputValue, decrypted.toString());
                next();
            });
        }.bind(this));

    });
    */

    it('should encrypt-decrypt desx-cbc', function (next) {

        var inputValue = '_PAYPAL_';

        var ppcrypto = new PPCrypto({
            encryptionAlgorithm: 'desx-cbc',
            macAlgorithm: 'sha1',
            encryptionKey: new Buffer(24),
            iv: new Buffer(8),
            padding: false
        });

        var desxcbc = ppcrypto.createCipherSpec();

        desxcbc.cipher(inputValue, function (encryptedDataBuffer) {
            desxcbc.decipher(encryptedDataBuffer, function (decryptedValue) {
                assert.ok(inputValue === decryptedValue.toString());
                next();
            });
        }.bind(this));

    });

});
