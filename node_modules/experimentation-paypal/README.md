node-experimentation
====================

Experimentation module for PayPal node.js applications


### Introduction

Experimentation module is experimentation middleware for nodejs apps using [PXP](https://confluence.paypal.com/cnfl/display/pxp/Home) using new PxpExecServ & with fallback to [PxpReadServ](https://github.paypal.com/Experimentation-R/PxpReadServ)

Experimentation depends on FPTI analytics. Make sure you are using [FPTI analytics](https://github.paypal.com/NodeServices/node-analytics) also.

You can create a new experiment by following the steps here
https://confluence.paypal.com/cnfl/display/pxp/PayPal+Experimentation+Platform+%28PXP%29+Tool


### End Points

Experimentation module uses predefined end points

 1. LIVE - http://api-pxp-int.paypal.com
 2. Rest - http://pxprest.qa.paypal.com:12534
 3. Sandbox - Right now experimentation is disabled for Sandbox as PXP is not deployed in Sanbox Env

 Sample stage url

 - [Sample request](http://pxprest.qa.paypal.com:12534/v1/experimentation/treatments?app=nodejstestweb&pg=nodejs_test&guid=2035bf8113f0a397a4d1e211fff8a187)
 - [Request to include factors](http://pxprest.qa.paypal.com:12534/v1/experimentation/treatments?guid=123&uid=1&sid=9&pg=pxp:rest:automation:factor&factors=true)


### Interface

 experimentation object has following methods which app team can leverage.
 This are for the current app and for a particular user request.
 - **getTrackingTags()** - return all the qualified tags.
 - **getAllTreatments()** - return all the qualified treaments.
 - **hasTreatment(treatmentNameorId)** - is treatment name qualified
 - **getTreatmentsWithFactor(factorName)** - get treatments with qualified factorName
 - **hasTreatmentsWithFactor(factorName)** - has treatments with qualified factorName
 - **getFactor(factorName)** - get factor based on factorName
 - **guid** - in case of no guid available in the request, pxp server returns guid.
 - **trackTreatmentIds(treatmentIds)** - (For APP Developer) pass a single treatmentId or an array of treatmentIds for which page is qualified.

### Config (optional)

```javascript
{
    useSession: true|false,        //default true, set false if you don't want to cache the experimentation result in session
    isMiddleware: true|false,   //default true, set false if you are using as controller, this way it will make sure experiementation middleware is not called.
    pg: "The app identifier configured in the experiment (please work with your test manager)",
    factors: false|true,         //default false, set true if to do factor based experimentation.
    beta: false|true             //default false, set true to do beta PXP.
}
```

**Note:** If an app running multiple experiments, then configure the same pg for all the experiments. It's an app identifier to narrow down the qualified experiments.


### PxpExecServ vs PxpReadServ

By deafult this module will connect to PxpReadServ till PxpExecServ ppaas matures. If a team want to try experimenting with PxpExecServ, use the following configuration in config.json

```
{
    "experimentation": {
        "usePxpExecServ": true
    }
}
```

### How to use

#### As Middleware

Experimentation in middleware is recommended when you don't have any specific ctx params and you want framework to build
req.experimentation before controller get the control.

`config.json`

```javascript
{
    "middleware": {
        ...

        "experimentation": {
                "enabled": true,
                "module": "experimentation-paypal"
            }

        ...

        }
}
```

with arguments

```javascript
{
    "middleware": {
        ...

        "experimentation": {
                "enabled": true,
                "module": {
                  "name": "experimentation-paypal",
                  "arguments": [{
                    "pg": "my_pg",
                    "useSession": false
                  }]

            }

        ...

        }
}
```

`Controller`

```javascript

//brogan already initializes experimentation and it's enabled by default.

app.get('/', function (req, res) {
    var exp = req.experimentation,               //In case you want to track custom data and add errors, else no need
        treatments = exp.getTreatments(),
        model = {},
        expFound = false;

    if (exp.hasTreatment('treatment_nodeapp_1')) {
        ...
        //app logic for treatment 1
        ...
        expFound = true;
        res.render('myDustView1', model);
        return;
    } else if (exp.hasTreatment('treatment_nodeapp_2')) {
        ...
        //app logic for treatment 2
        ...
        expFound = true;
        res.render('myDustView2', model);
        return;
    } else {
        ...
        //app logic default behavior
        ...
        res.render('myDustView', model);
    }

});
```

#### From Controller

Calling Experimentation from controller is recommended when you want to send additional app specific ctx params to pxp server.
One of the param is `pg`, which signifies PXP pagename, to get this value contact [PXP team](mailto:DL-PayPal-PXP-Engineering <DL-PayPal-PXP-Engineering@paypalcorp.com>).
Also to force middleware experimentation not to be called, use `isMiddleware:false` configuration

- remove the reference of experimentation-paypal from `config.json`

Sample code

```javascript
var app = express();                                    //express
var experimentation = require('experimentation');        //require declaration

app.get('/', function (req, res) {
    var model = {},
        expFound = false,
        params = {
            'pg' : 'pagename, contact pxp team to get this',    //mandatory (instead can be passed as config also)
            'factors': true,
            'Ctx.appSpecificParamStr' : 'value',
            'Ctx.appSpecificParamNo' : 100,
            'Ctx.appSpecificParamBoolean' : true
        };

    experimentation.pxp(req, params, function (error, exp) {    //Passing app specific params in the request

        if (!error) {
            if (exp.hasTreatment('treatment_nodeapp_1')) {
                ...
                //app logic for treatment 1
                ...
                expFound = true;
                res.render('myDustView1', model);
                return;
            } else if (exp.hasTreatment('treatment_nodeapp_2')) {
                ...
                //app logic for treatment 2
                ...
                expFound = true;
                res.render('myDustView2', model);
                return;
            } else {
                ...
                //app logic default behavior
                ...
                res.render('myDustView', model);
            }
        }
    });

});
```

####  Opt in and Opt out

Details
https://github.paypal.com/Experimentation-R/PxpReadServ#-opt-in-request

https://github.paypal.com/Experimentation-R/PxpReadServ#-opt-out-request

Sample code

```javascript
var app = express();                                     //express
var experimentation = require('experimentation');        //require declaration

app.get('/', function (req, res) {
        var    params = {
            treatment_name : < treatment name >  // treatment Name
            method      : 'optin' or 'optout'
            site        : < country-code > // [optional]
        };

        experimentation.optInOrOut(req, params, function (error, response) {
            if(!error && response.statusCode === 200) {
                SUCCESS
            }

        }
    }
```

### Testing override (Dev, Stage only)

To enforce different treatment, you can override the FPTI guid by adding ?_guid=[fpti_guid] in the url.
