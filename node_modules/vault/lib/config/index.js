'use strict';

var config  = require('./config'),
    pputil  = require('../pputil'),
    keywrap = require('../keywrap');





function load(pin, file, callback) {
    config.load(file, function (err, data) {
        var rfc, kek;

        if (err) {
            callback(err);
            return;
        }

        // Decode all base64 values
        data.transform(function (key, value) {
            return pputil.isBase64(key) ? pputil.base64Decode(value) : new Buffer(value, 'ascii');
        });

        rfc = keywrap.createKeyWrapper('rfc5649');
        kek = rfc.unwrap(data.get('b64_aes_key'), pin.slice(0, 16));

        // Decrypt all encrypted values
        data.transform(function (key, value) {
            return pputil.isEncrypted(key) ? rfc.unwrap(value, kek) : value;
        });

        callback(null, data);
    });
}


exports = module.exports = {

    load: load

};