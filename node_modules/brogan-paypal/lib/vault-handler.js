'use strict';

var vault = require('vault'),
    debuglog = require('debuglog')('brogan-paypal');

/**
 * Handler for vault: protocol in config.
 * @param options
 * @returns {Function}
 */
function vaultHandler(options) {
    var queue, vaultpkg;

    queue = [];

    function onvault(error, pkg) {
        var req;

        vaultpkg = pkg;

        error && debuglog('error: %s', error.message);

        while (req = queue.shift()) {
            if (error) {
                req.cb(error);
                return;
            }

            req.cb(null, pkg.get(req.key));
        }
    }

    return function vaultHandler(key, cb) {

        if (vaultpkg) {
            cb(null, vaultpkg.get(key));
            return;
        }

        queue.push({ key: key, cb: cb });

        if (queue.length > 1) {
            return;
        }

        debuglog('initializing vault.');

        vault.create(options || {}, onvault);
    };
}

exports = module.exports = vaultHandler;
