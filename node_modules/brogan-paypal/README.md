# brogan

A simple module for adding PayPal support to kraken applications.

### Features

`brogan` adds support for the following:

- topos
- vault protocol in configs
- servicecore configuration
- provide standard Infra configuration
- enforces these Infra dependencies
    - cal
    - commons-paypal
    - pplogger
    - express-meta
    - ecv-paypal
    - analytics-paypal
    - keebler-paypal
    - monitor-paypal
    - connect-mayfly
    - device-detection-paypal


### API
`brogan` is designed to work as a wrapper for krakenjs's configuration options.

Example:

```javascript
var app = express(),
    kraken = require('kraken-js'),
    brogan = require('brogan-paypal'),
    options = {
        onconfig: function(config, next) {
            next(null, config);
        }
    };

app.use(kraken(brogan(options)));

app.listen(port, function (err) {
    if (err) {
        console.error(err);
    }
});
```

For all configuration options, see [kraken-js optons](https://github.com/krakenjs/kraken-js#options).

### Using vault protocol handlers in configs (or topos)

To use `vault` keys in configurations, simply use the `vault:` protocol handler.

Example:

```json
{
    "client_credentials": "vault:client_credentials"
}
```

### Vault options

Additional `vault` options can be passed in the brogan configuration as a `vault` property.

Example:

```javascript
var options = {
    onconfig: function(config, next) {
        next(null, config);
    },
    vault: vaultOptions
};

var app = kraken(brogan(options));
```

See [vault options](https://github.paypal.com/NodeInfra/node-vault#api).

### `brogan-paypal@^3` explained

##### Consistent Infra dependencies and middleware order
 
To avoid repeating past incidents where the sole reason of app failing was either missing infra dependency or middleware misconfiguration in `config.json`. Now brogan will injects these default (https://github.paypal.com/NodeInfra/brogan/blob/a4d23829ecfdb240a17f34e265717ab06bfbad96/config/config.json#L39) Infra dependencies. Ideally you should let these configs take into effect and override only if app requires non-default configuartions. 

Along with above config changes, `brogan-paypal@^3` will ensure app upgrade to minimum stable version of these Infra modules - https://github.paypal.com/NodeInfra/brogan/blob/a4d23829ecfdb240a17f34e265717ab06bfbad96/package.json#L41.

##### Faster ECV check

With this brogan upgrade, we added `ecv-paypal` module with meddleware priority `51`. Means now ecv requests (OPS request to check if app is up and responsive or not) will be much lighter & faster. Putting it before all the other middlewares means it won't consume too many resources while app is taking regular traffic. 

Now on an average ECV requests (usually once every 5s) takes 0.02-0.1ms instead of 1-2ms to respond. 

##### CSRF mismatch fix

CSRF mismatch has been one of the common cause of errors and great mystery in node apps. 
Sometime it might be some hacker trying to fiddle around or other times it might be the combination of `async; fire and forgot` nature of express-session module and high latency in mayfly save call(~>15ms).

Now for any http response end's, before express-session try to save the session in `async; fire and forgot` manner; connect-mayfly's `forceSessionSave` middleware will save the session (earlier this logic was in `pplogger`) in `sync; get ack` way. This will make sure session is saved for sure, before the next request comes and asks for the same session object. So no false CSRF mismatch issues.
