'use strict';

var fs = require('fs'),
    path = require('path'),
    util = require('util'),
    debug = require('debuglog')('ecv');

var ecvData =
    '<html><head><title>ECV Control: In</title></head><body><p>Request: To be in rotation</p></body></html>';

function ecvCheck(req, res) {
    var ecv_status_file;

    if (process.env.ECV_TEST_FILE) {
        ecv_status_file = process.env.ECV_TEST_FILE;
    } else {
        ecv_status_file = '/x/web/ECV/control.html';
    }
    debug('%s: ecv status check...', Date.now());

    res.setHeader('Cache-Control', 'no-cache');
    res.writeHeader(200, {
        'Content-Type': 'text/html'
    });
    fs.readFile(ecv_status_file, function (err, data) {
        if (err) {
            res.end(ecvData);
        } else {
            res.end(data);
        }
    });
}


module.exports = function ecv(options) {

    options = options || {};

    return function ecv(req, res, next) {
        var url,
            urlLength,
            checkUrl;

        url = (req.path || req.url).replace(/\/\//g, '/');
        urlLength = url.length;

        if (url.charAt(urlLength - 1) === '/') {
            url = url.substr(0, urlLength - 1);
        }

        url = url.split('/');
        checkUrl = url[url.length - 1];

        if (checkUrl === 'ecv') {
            ecvCheck(req, res, next);
            return;
        }

        next();
    };
};
