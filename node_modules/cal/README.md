A NodeJs CAL Client
-----------------------------

This node module implements the [CAL](https://confluence.paypal.com/cnfl/display/CAL/CAL+Cookbook) protocol to bring CAL data publishing to NodeJs applications.

## CAL Intro/References
 - [CAL: Live](http://cal.vip.paypal.com/)
 - [CAL: Altus Status](http://mscal.qa.paypal.com/)
 - [CAL: Staging](http://cal-stage.qa.paypal.com/)
 - [CAL: Sandbox](http://sb-cal-vip.slc.paypal.com/)
 - [CAL: Live Hadoop](https://sherlock.paypalcorp.com/ppreports/)
 - [CAL cookbook](https://confluence.paypal.com/cnfl/display/CAL/CAL+Cookbook)
 - [PayPalOne](https://github.paypal.com/pages/Hacks/PayPalOne/)


To use CAL in your application, add these following modules in package.json:

```javascript
{
  ...
  "cal": "^0.5.30",
  "continuation-local-storage": "^3.0.0"
  ...
}
```

then import the module when you want to use it:

```javascript
var cal = require('cal');
```

## Middleware
CAL middleware is express style middleware, responsible for creating and managing virtual threadId lifecycle.


#### bare express app
In bare express app, add the `cal.middleware` in middleware chain as:

```
var app = require('express');
var cal = require('cal');
...

app.use(cal.middleware());

app.get('/', function (req, res, next) {

  var calEvent = cal.createEvent('REQUEST', 'INFO');
  var requestData = {
    path: req.path,
    query: req.query
  };
  calEvent.addData(requestData);
  calEvent.complete();

  res.send('hello world');
});
```

#### kraken app

config.json

This is already configured in `brogan-paypal@3.0.0`

```json
{
  "middleware": {
    ...
    "cal": {
        "enabled": true,
        "priority": 90,
        "module": {
            "name": "cal/middleware"
        }
    },
    ...
  }
}

```

usage in controller or lib

```js
//CAL Event

  var calEvent = cal.createEvent('NAME', 'TYPE');
  calEvent.addData(json_data);  //json object
  calEvent.addData('key', 'value'); //key, value
  calEvent.status = cal.Status.SUCCESS; //can be SUCCESS|ERROR|WARNING
  calEvent.complete();


//CAL Atomic Transaction - for async operations, where you are interested in total time as well.

  var calTransaction = cal.Transaction('NAME', 'TYPE');
  callThisFunction(inputs, function (err, results) {
    if (err) {
      calTransaction.addData(err);
      calTransaction.status = cal.Status.ERROR;
    } else {
      calTransaction.addData(json_data);  //json object
      calTransaction.status = cal.Status.SUCCESS; //optional; by default it's SUCCESS
    }
    calTransaction.complete();
  });

```

Refer to [pplogger](https://github.paypal.com/NodeInfra/pplogger) for shorthand utility and root transaction.

## Configuration

#### enableBuffering
App can update the root transaction name by enabling buffering. If enabled, CAL will buffer messages when it receives `t` and flush everything when it receives `T`.

```js
    "cal": {
        "enableBuffering": true|false
    }
```

#### enableNestedCal
App can enable nested cal transactions. If enabled, apps can use async version of cal transaction API.

```js
    "cal": {
        "enableNestedCal": false|true
    }
```


## API
The CAL module consists of a default global logger and an API to create custom loggers. Each logger can be configured with a `formatter` and a `writeStream`. By default, all loggers are pre-configured with the CAL message format and the caldaemon writeStream.

#### createEvent(type, name, [status], [data])
See Logger.createEvent()

#### createHeartbeat(type, name, [status], [data])
See Logger.createHeartbeat()

#### createTransaction(type, name, [status], [data], [parent], [callback])
See Logger.createTransaction()

#### createLogger([options])
Creates a custom logger instance which uses any provided options or inherits settings from the default logger configuration. Configurable options are `formatter` and `writeStream`.

```javascript
// No formatter is specific, so the default global formatter is used
var logger = cal.createLogger({
  writeStream: process.stdout
});
// ...
// var event = logger.createEvent(...);
```

### defaults (get/set)
Allows configuration of global default options `formatter` and `writeStream`.

```javascript
// Default logger and all new loggers will format messages as JSON
cal.defaults = {
     formatter: cal.formatter.JSON
};
```

### Status
Constants for use with the status mesasge property. Values are `SUCCESS`, `FATAL`, `ERROR`, `EXCEPTION`, and `WARNING`.

```javascript
event.status = cal.Status.SUCCESS;
```

### stream
A property that exposes the built-in stream types. Any writeable-stream can be used, however.
Built-in streams are `cal`, `console`, and `file`. See below for configuration options of the built-in streams.

```javascript
cal.setDefaultWriteStream('file', { path: '/path/to/log/file'});
```

### formatter
This property exposes built-in formatters. Any object that conforms to the formatter API can be used, however.
The built in formatters are `cal`, `JSON`, `silent`, `pretty` and `console`.

```javascript
cal.defaults.formatter = cal.formatter.JSON;
```

### Logger
A logger instance allows clients to create and log CAL messages. The API is very similar to the default CAL API.

#### createEvent(type, name, [status], [data])
Creates a CAL Event object initialzed with the provided options.

```javascript
var cal = require('cal');

var event = cal.createEvent('my type', 'my name');
event.addData('key', 'value');
event.addData({ foo: 'bar' });
event.complete();
```

#### createHeartbeat(type, name, [status], [data])
Creates a CAL Heartbeat object initialzed with the provided options.

```javascript
var cal = require('cal');

var hb = cal.createHeartbeat('my type', 'my name');
hb.addData('key', 'value');
hb.addData({ foo: 'bar' });
hb.complete();
```

#### createTransaction(type, name, [status], [data], callback)
Creates a CAL Transaction object initialzed with the provided options.

```javascript
var cal = require('cal');

var calTxn = cal.createTransaction('my type', 'my name');
calTxn.addData('key', 'value');
calTxn.addData({ foo: 'bar' });
// optional calTxn.flush();

calTxn.complete();
```

if `enableNestedCal:true`, you can use async version of this API.

```javascript
var cal = require('cal');

cal.createTransaction('my type', 'my name', function(err, calTxn) {
    calTxn.addData('key', 'value');
    calTxn.addData({ foo: 'bar' });
    // optional calTxn.flush();
    calTxn.complete();
});
```

### options (get/set)
Change the configuration options (such as `formatter` and `writeStream`) of the current logger. It is not recommended to change these values unless you know what you are doing. For example, swapping streams while attempting writes could cause unexpected behavior.


## Message Types
### Event
Events are used merely for logging data. For performance or profiling information, Transactions are the message type of choice.
#### Properties
`type` - The message type as speficied in the CAL protocol.

`name` - The message name as speficied in the CAL protocol.

`status` - The message status as speficied in the CAL protocol.

#### Methods
`addData(key, value), addData(encodedString), addData(object)` Adds data that will be captured/logged with this event.

`complete([status])` Finalizes and commits the event.

### Heartbeat
#### Properties
`type` - The message type as speficied in the CAL protocol.

`name` - The message name as speficied in the CAL protocol.

`status` - The message status as speficied in the CAL protocol.

#### Methods
`addData(key, value), addData(encodedString), addData(object)` - Adds data that will be captured/logged with this heartbeat.

`complete([status])` - Finalizes and commits the heartbeat.


### Transaction
#### Properties
`type` - The message type as speficied in the CAL protocol.

`name` - The message name as speficied in the CAL protocol.

`status` - The message status as speficied in the CAL protocol.

`duration` - Manually sets/override the duration of this transaction.

`correlationId` - Marks this transaction with the provided correlationId.

`parent` - Creates a relationship with the provided transaction, allowing nested profile information to be captured.

#### Methods
`addData(key, value), addData(encodedString), addData(object)` - Adds data that will be captured/logged with this transaction.

`flush()` - Flushes the current data and start time of the transaction. Transactions logged without a flush event will be marked as ATOMIC, while flushes mark them with START and STOP events. The same information is captured.

`complete([status])` - Finalizes and commits the transaction.


### Formatters
A formatter is any object that defines a property named `format` which defined a function with the signature `function (args)`.
For example, the JSON formatter is simply:

```javascript
module.exports = {
    format: functon (args) {
         return JSON.stringify(args);
    }
}
```

Built-in formaters are `cal`, `console`, `silent`, `pretty`, and `JSON`.

### Write Streams
Write streams are exactly as they sound. They are the stream that the message should be written to. Any
writable stream can be provided. Built-in writeStreams include `cal`, `console`, and `file`.

