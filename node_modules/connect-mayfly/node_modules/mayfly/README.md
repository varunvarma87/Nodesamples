node-mayfly (based on Mayfly2 Spec)
===========

### Configuation

This is the format of mayfly configuration object.

```bash
var config = {
       appName: "",    //default 'NodeMayflyClient'
       namespace : "",  //default 'NodeClient'
       lifetime : 18000,    //default  3 days in sec
       crypto : true|false, //Use data encryption
       enableDataAffinity : false|true  //data affinity feature.
    }
```
Let's discuss each of the option in detail.

 - **appName** - Name of the application.
 - **namespace** - This is to identify the client. By default it will be 'NodeClient'. recommended not to overwrite.
 - **lifetime** - lifetime of each mayfly record (in sec). After the seconds are over, server will automatically delete the record. Default and max value is 3 days.
 - **noRetries** - number of retries for connection
 - **timeout** - timeout for connection to mayfly directory server
 - **crypto** - Boolean configuration option to decide if to use data encryption.
 - **enableDataAffinity** - disabled by default. [Data Affinity](https://confluence.paypal.com/cnfl/display/mayfly/Client+Data+Affinity)


**Continuous Availablity Support**

To support CA in stages and LIVE, layout.json has `ipport`.
format for ipport - `<priority>:<qualified host name or ip>:<port>{[^<priority>:<qualified host name or ip>:<port>]}`
Since this has higher priority than simple ip and port, so mayfly will be using it to resolve ip and ports in stages and LIVE.

## Overview

One of PayPal's important infrastructure is Mayfly2, an in-memory data store / data cache.

Mayfly is a key-based in-memory database system, with both intra-site and inter-site data backup to guarantee high reliability and availability. Data is stored in a very flexible key-value format. It offers full Create, Read, Update and Delete (CRUD) operation.
Communication with Mayfly2 is via TCP/IP sockets transmitting Mayfly messages using a proprietary binary protocol. The Mayfly protocol is completely stateless and communication is a typical request-response pattern.


##### Mayfly Server

Mayfly server is a stage/hyper/LIVE box that's running mayflydirectoryserv service.

For mayfly server 10.x.x.x, mayfly admin console is available at
```bash
http://10.x.x.x:10369/stats.
```

To debug and see server logs, follow these steps

```bash
ssh 10.x.x.x
tail -f /x/web/STAGE2XXXX/mayflydirectoryserv/logs/mayflydirectoryserv/current
 ```

##### Message Format

message format is discribed here [Mayfly2 Client](https://confluence.paypal.com/cnfl/display/ICARUS/Icarus+Mayfly2+Client)

##### Serialization/Deserialization

https://github.paypal.com/Infrastructure/infra/blob/master/all/ifeature/service/mayflyng/shared/Msg.cpp



## To Play with it


1. Run npm install to load the dependencies
```bash
$ npm install
```

2. To see the sample crud operation using node-mayfly.
```bash
$ node app.js
$ node app.js --perf=true --load=100 --timeout=1000 #optional arguments to run load testing
```

3. To run unit tests
```bash
$ make test
```

4. To generate and deploy code coverage
```bash
$ make cover          #generate coverage locally
$ make cover.deploy   #generate coverage + deploy to github pages
```
