'use strict';

var path = require('path'),
    fs = require('fs'),
    assert = require('assert'),
    readline = require('readline'),
    utils = require('../lib/utils');


describe('Mayfly Affinity Hash', function () {

    it('Hash comparisons 1', function (next) {

        var inputs = [
            'abcdefghijklmnopqrstuvwxyABCDEFGHIJKLMNOPQRSTUVWXYZz1234567890',
            'dmwuKu7TKLunDKOtU6FbEVHig84pjOG9e3OKfJ4',
            'SPGEA',
            'Uwf4KHIl9dR18p93JtdzbZyG5SDFiFsijiQzw',
            'V0OVfg',
            'RjCXVBNi0BMYJ1IOoVfGG3Shsz219IOAg8Hf7',
            '9zefV5uwl0AwHaZoG9aa0cTLT0Lls2DFxjCxxG',
            'RdchrCJ3yzjnJctAMpAK',
            'jX0it1RNgr',
            '2tiWnze',
            'UfMfpZOY5JF',
            'tU6RSGM6zVoetxyLbHCynQ8J0eqRBlEhY',
            'ifJ3lt9lipxG2cYI8snKliH',
            '5obwLZOoHo5cQbzwB',
            '5c5',
            'crQUYgnxsysuSBzS1r',
            '2rTgxbhwzqwrmug6a1RpZbYB',
            'CH4b8sxrAe8yC85OcfbDUD4mqqjoWYgQqk0w2YS',
            'CVbHPpkXy8T6gzIEMp1cHwPHeAJ0mEKFfv',
            'DKWZQgN5unsDL7mmMB6tDxJxJmsURWxHuorl4',
            '8SNp7rtZT2EFf94mv1a'
        ];

        var expectedHashes = [
            140623488,
            230799796,
            5786513,
            195445783,
            93670599,
            40347159,
            13206647,
            188101899,
            7384978,
            162457141,
            97483318,
            264308089,
            3936968,
            174983506,
            15205,
            109128914,
            45424018,
            174058483,
            18576262,
            118870068,
            230235665
        ];

        var index, hash;
        for (index in inputs) {
            hash = utils.affinityHash(inputs[index]);
            assert.ok(hash === expectedHashes[index]);
        }
        next();
    });

    it('Hash comparisons 2', function (next) {

        var inputs = [],
            expectedHashes = [],
            index, hash;

        var inputRd = readline.createInterface({
            input: fs.createReadStream(path.join(__dirname, '/affinity/key_inputs.txt')),
            terminal: false
        }),
            expectedRd = readline.createInterface({
            input: fs.createReadStream(path.join(__dirname, '/affinity/expected_hashes.txt')),
            terminal: false
        });

        inputRd.on('line', function (line) {
            inputs.push(line);
        });

        expectedRd.on('line', function (line) {
            expectedHashes.push(line);
        });

        for (index in inputs) {
            hash = utils.affinityHash(inputs[index]);
            assert.ok(hash === expectedHashes[index]);
        }
        next();
    });

});
