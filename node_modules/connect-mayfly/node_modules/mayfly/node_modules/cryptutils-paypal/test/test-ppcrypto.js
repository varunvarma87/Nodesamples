/*global describe:false, before:false, it:false*/
'use strict';

var ppcryptutils = require('../lib'),
    assert = require('chai').assert;

describe('PPCrypto', function () {

    var cookieStruct = new Buffer([91, -91, 92, 37, -41, -67, -124, 29, -57, 123, 3, 0, 0, 0, 0, 0, 10, 0, 0, 0, 87, 50, 19, 74, 0, 0, 80, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]);

    var encryptTestCookie = 'KIed4ZuzuUaptYM7aPu7v7Y-CwoKuJ3_TkcpcYVV0zH0yHCzFkTqnsHMLTKuSgtDHOHQhRSkLF8xs0866ucpGrVgimUGFW7yB66EfG5HxBKrIpDYJ9L0d0COWl_O4xoUwP7Q20';

    var configuration = {
        encryptionAlgorithm: 'desx',
        macAlgorithm: 'sha1',
        encryptionKey: new Buffer('1h1P/y6F/kg6OlM7oeTms2Yr6Lw=', 'base64'),
        macKey: new Buffer('SF4HNI/A1U3xPww2eylPqJNQIvU=', 'base64')
    };

    var configurationBeacon = {
        encryptionAlgorithm: 'des-ede3-cbc',
        macAlgorithm: 'sha1',
        encryptionKey: new Buffer('jtf5ScpoGd6NpM0h2FpOqSBhTsB6WK0p', 'base64'),
        macKey: new Buffer('EDqF73KW1QQagrDEx1g1LwPOJm0=', 'base64')
    };


    before(function (next) {
        next();
    });

    it('should seal Beacon URL', function () {
        var ppcrypto = ppcryptutils(configurationBeacon);

        var data = ppcrypto.sealAndEncodeBeacon(new Buffer('p=12345678&t=12345&i=1.2.3.4&l=1&v=98765432'));

        assert.strictEqual(data.toString(), 'm-Q8LCj4dm2Mzog5rnBPFzixGaZNCUYKuwYmfznfwrU9CbuYXNv1yQLhPSW9uTXkBol7xAC3ULNBYN57Ako2PGM-sOo1Lg6W_pRSZg');
    });

    it('should unseal Beacon URL', function() {
        var ppcrypto = ppcryptutils(configurationBeacon);

        var data = ppcrypto.decodeAndUnsealBeacon(new Buffer('m-Q8LCj4dm2Mzog5rnBPFzixGaZNCUYKuwYmfznfwrU9CbuYXNv1yQLhPSW9uTXkBol7xAC3ULNBYN57Ako2PGM-sOo1Lg6W_pRSZg'));

        assert.strictEqual(data.toString(), 'p=12345678&t=12345&i=1.2.3.4&l=1&v=98765432');
    });

    it('should seal Hello World', function () {

        var ppcrypto = ppcryptutils(configuration);

        var data = ppcrypto.sealAndEncode(new Buffer('Hello World'));

        assert.strictEqual(data, 'EeID2labT1Xskqv5sMSXtAGUMDzrt1eljVgdzU5PTlCwKloaAodwdQDqfzW');
    });

    it('should unseal Hello World', function () {

        var ppcrypto = ppcryptutils(configuration);

        var data = ppcrypto.decodeAndUnseal(new Buffer('EeID2labT1Xskqv5sMSXtAGUMDzrt1eljVgdzU5PTlCwKloaAodwdQDqfzW'));

        assert.strictEqual(data.toString(), 'Hello World');
    });

    it('should seal cookie', function () {

        var ppcrypto = ppcryptutils(configuration);

        var data = ppcrypto.sealAndEncodeNamed('user_session', cookieStruct);

        assert.strictEqual(data, encryptTestCookie);
    });

    it('should unseal cookie', function () {

        var ppcrypto = ppcryptutils(configuration);

        var data = ppcrypto.decodeAndUnsealNamed('user_session', new Buffer(encryptTestCookie));

        assert.strictEqual(data.toString('hex'), cookieStruct.toString('hex'));
    });

    it('should hmac the name', function () {

        var hmac = ppcryptutils.hmacString(configuration.macAlgorithm, configuration.macKey, 'user_session');

        assert.strictEqual(hmac, 'TVKbnJIgoopqCTftP3PCeQTrLnu');
    });

    /**
     * This does both because it encrypts one way - i.e. you can't check it except to unseal it.
     */
    it('should encrypt/decrypt rlogid', function () {

        var inputValue = 'nodejstestweb::lm-sjn-00713581';

        var ppcrypto = ppcryptutils({
            encryptionAlgorithm: 'des-ede3-cbc',
            macAlgorithm: 'sha1',
            encryptionKey: new Buffer('mjok7Ye1bVDHkCDMQZUvZ8VhkawCvhoM', 'base64'),
            macKey: new Buffer('8rH6RMptN2O3kH4YwJQFyA-owRM', 'base64')
        });

        var data = ppcrypto.macKeyStringXorEncryptAndEncode(new Buffer(inputValue));

        var original = ppcrypto.macKeyStringXorDecryptAndDecode(data);

        assert.strictEqual(original, inputValue);
    });

    it('should decrypt rlogid encrypted in Java', function () {

        var inputValue = 'marketingspartaweb::slcspartamp3027a';
        var expectedValue = 'pgPczdYpBs23BkNh0ThnaJai4PgoWJQdT25CqhYbXNOaICZctMfMmjsoz6LGMk8/lR9+oqbLjOpmjs0lsXO80A';

        var ppcrypto = ppcryptutils({
            encryptionAlgorithm: 'des-ede3-cbc',
            macAlgorithm: 'sha1',
            encryptionKey: new Buffer('mjok7Ye1bVDHkCDMQZUvZ8VhkawCvhoM', 'base64'),
            macKey: new Buffer('8rH6RMptN2O3kH4YwJQFyA-owRM', 'base64')
        });

        var data = ppcrypto.macKeyStringXorDecryptAndDecode(expectedValue);

        assert.strictEqual(data, inputValue);
    });

    it('should encrypt-decrypt des-cbc', function () {

        var inputValue = '_PayPal_';

        var descbc = ppcryptutils.createCipherSpec('des-cbc', new Buffer('01254567', 'utf8'));

        var data = descbc.decipher(descbc.cipher(inputValue));

        assert.strictEqual(data.toString(), inputValue);
    });

    it('should encrypt-decrypt aes-256-cbc', function () {

        var inputValue = 'Test';

        var aes256 = ppcryptutils.createCipherSpec('aes-256-cbc', new Buffer(32), true);

        var data = aes256.decipher(aes256.cipher(new Buffer(inputValue)));

        assert.strictEqual(data.toString(), inputValue);
    });

    it('should encrypt-decrypt desx-cbc', function () {

        var inputValue = '_PAYPAL_';

        var desxcbc = ppcryptutils.createCipherSpec('desx-cbc', new Buffer(24), false, new Buffer(8));

        var data = desxcbc.decipher(desxcbc.cipher(inputValue));

        assert.strictEqual(data.toString(), inputValue);
    });

});
