# Connect Mayfly

connect-mayfly is a Mayfly session store backed by [node_mayfly](https://github.paypal.com/NodeServices/node-mayfly).
This allows you to connect to PayPal's own session store from node.js apps using express/connect.


## Installation

```bash
$ npm install connect-mayfly
```

## Options

  - `appName` App name, for logging purpose
  - `noRetries` number of retries for connection
  - `timeout` timeout for connection to mayfly directory server
  - `crypto` Boolean value (true|false) to use data encryption
  - `algorithm` If crypto is true and you want to use algorithm other than `aes-256-cbc`. Refer [node-mayfly](https://github.paypal.com/NodeServices/node-mayfly) for details
  - `prefix` Key prefix defaulting to "sess:"
  - `sharedSession` enable the shared session to share csrf in-between node apps. default `false`.

The options can be configured in config/config.json in a section like:
```javascript
{
  "middleware": {
    ...
    "session": {
      "enabled": true,
      "priority": 100,
      "module": {
        "name": "connect-mayfly/middleware",
        "arguments": [
          {
            "cryptKey": "vault:encrypted_mayflysession_crypt_key",
            "macKey": "vault:encrypted_mayflysession_mac_key",
            "cookie": {
              "path": "/",
              "httpOnly": true,
              "maxAge": null
            },
            "sharedSession": true
            "proxy": null
          }
        ]
      }
    }
    ....
  }
}
```

## Usage

 Add connect-mayfly in package.json dependencies

```javascript
"connect-mayfly": "~0.4.0"
```

```javascript
var session = require('express-session'),
    MayflyStore = require('connect-mayfly')(session),
    config = {
        lifetime: 3600
    };

express().use(session({ store: new MayflyStore(config), secret: 'keyboard cat' }));
```

By doing this connect-mayfly build on `session.Store` object.


## Session Sugar

 - This module will add _isNewSession: true|false key in returned session object to tell if it's a new session or not.
 - It also adds _sessionLen in returned session supplying the length of the retrieved session object. Used to avoid a stringify elsewhere to determine the length.

## Test & Run

```bash
$ npm install
$ make test       # to run tests
```
