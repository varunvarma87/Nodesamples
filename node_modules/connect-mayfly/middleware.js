'use strict';

var session = require('express-session'),
    config = require('./config'),
    MayflyStore = require('./index')(session);

module.exports = function (settings) {
    settings = config(settings);
    settings.store = new MayflyStore(settings);
    return session(settings);
};

module.exports.forceSessionSave = function () {

    return function sessionsave(req, res, next) {
        var end = res.end;

        res.end = function () {
            var _arguments = arguments;

            if (req.session) {
                //if session, then save first and then end the request
                req.session.save(function (err) {
                    req.isSessionAlreadySaved = true;   //To avoid double session save
                    end.apply(res, _arguments);
                });
            } else {
                end.apply(res, _arguments);
            }
        };
        next();
    };
};
