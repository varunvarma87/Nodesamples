'use strict';
var fs = require('fs'),
	Store = require('istanbul').Store,
	store = Store.create('memory');

module.exports = function (grunt) {
	/**
	* Grunt Task to Store file contents
	*/
	grunt.registerMultiTask('store', 'Task to store the contents into the istanbul store', function () {
		
		this.filesSrc.forEach(function (filepath) {

			grunt.log.writeln('Storing the file -' + filepath);
			fs.readFile(filepath, 'utf-8', function (err, data) {
				if (err) {
					grunt.fail.fatal(err, 1);
				}
				store.set(filepath, data);
			});
		});
	});

	/**
	*Grunt Task to Retrieve file contents
	*/
	grunt.registerMultiTask('retrieve', 'Task to retrieve the contents from the istanbul store', function () {
		
		this.filesSrc.forEach(function (filepath) {
			grunt.log.writeln('Retrieving the file -' + filepath);
			if (store.hasKey(filepath)) {
				fs.writeFile(filepath, store.get(filepath), 'utf-8', function (err) {
					if (err) {
						grunt.fail.fatal(err, 1);
					}
				});
			}
			
		});
	});
};
