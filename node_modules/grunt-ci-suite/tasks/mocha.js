/*
* Inspired by the grunt-simple-mocha module
* 
*/
"use strict";
var path = require('path'),
    Mocha = require('mocha');

module.exports = function (grunt) {
    grunt.registerMultiTask('mochatest', 'Run tests with mocha', function () {
        var files = [],
          options = this.options(),
          mochaRunner = new Mocha(options);
        grunt.log.writeln("Running Mocha tests on files");
		//Sync execution to resolve the path
		for (var i = 0; i < this.filesSrc.length; i++) {
			files.push(path.resolve(this.filesSrc[i]));
		}
		
        files.forEach(function (filepath) {
            grunt.log.writeln(filepath);
        });
        grunt.log.writeln();
        files.map(mochaRunner.addFile.bind(mochaRunner));
        var done = this.async();
        try {
            mochaRunner.run(function (errCount) {
                var withoutErrors = (errCount === 0);
                done(withoutErrors);
                if (withoutErrors) {
                    grunt.log.writeln();
                    grunt.log.ok("Successfully completed Mocha tests!");
                    grunt.log.writeln();
                }
            });
        } catch(e) {
            console.log(e.stack);
            done(false);
        }
    });
};

