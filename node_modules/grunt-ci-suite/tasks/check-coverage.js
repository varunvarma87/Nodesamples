'use strict';
var fs = require('fs'),
    path = require('path'),
    shell = require('shelljs');

module.exports = function (grunt) {

    /**
     * Grunt Task to check code coverage thresholds
     */
    grunt.registerMultiTask('checkcoverage', 'Task to check code coverage thresholds', function () {

        var options = this.options(),
            command = require.resolve('.bin/istanbul'),
            statements = options.statements || 80,
            functions = options.functions || 80,
            branches = options.branches || 80,
            lines = options.lines || 80,
            includePattern = options.includePattern || '';

        grunt.log.writeln();

        command = command + ' check-coverage --statements ' + statements + ' --functions ' + functions + ' --branches ' + branches + ' --lines ' + lines + ' ' + includePattern;
        grunt.log.writeln('Executing the istanbul check coverage command - ' + command);
        grunt.log.writeln();
        var done = this.async();
        shell.exec(command, {silent:true}, function(code, output){

            var withoutErrors = (code === 0);
            if (withoutErrors) {
                grunt.log.writeln();
                grunt.log.ok('Istanbul code coverage thresholds met!');
                grunt.log.writeln();
            } else {
                grunt.fail.warn(output);
            }
            done(withoutErrors);
        });
    });
};
