"use strict";
var path = require('path'),
    Mocha = require('mocha'),
    fs = require('fs'),
    mochaRunner;

function run(cb) {
	var files = [],
		options,
		filesSrc,
		optFilePath = path.join(__dirname, 'options.json'),
		tmpOpt = {};
    
    console.log("Running Mocha tests on files");
    //Retrieve the Mocha options from temporory file
    //Using sync to simplify the logic. Yeah- the async call dont save much of a time here.
    if (fs.existsSync(optFilePath)) {
		tmpOpt = require(optFilePath);
	}
	options = tmpOpt.options || {};

	options.globals = options.globals || [];
	// Don't do global leak check on temporary istanbul files.
	options.globals.push('__cov_*');
	mochaRunner = new Mocha(options);
	filesSrc = tmpOpt.files || [];

	//Sync execution to resolve the path
	for (var i = 0; i < filesSrc.length; i++) {
		var filePath = path.resolve(filesSrc[i]);
		console.log(filePath);
		files.push(filePath);
	}

    console.log();
    files.map(mochaRunner.addFile.bind(mochaRunner));
    cb && cb ();
    
}

run(function (err) {
	if (!err && mochaRunner) {
		mochaRunner.run(function (failures) {

			var withoutErrors = (failures === 0);
            if (withoutErrors) {
                console.log();
                console.log("Successfully completed Mocha tests!");
                console.log();
            }
			process.exit(failures);
		});
	} else {
		console.log("Error in executing Mocha runner");
	}

});