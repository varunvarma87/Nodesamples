"use strict";
var fs = require("fs"),
	libxmljs = require("libxmljs");

module.exports = function(grunt) {
	grunt.registerMultiTask('autowrap', 'check last set of xunit files for any failures', function () {
		var files = this.filesSrc,
			ts = 0,
			latestFiles = [],
			failNames = [],
			failJSON = {
				"iterations": []
			},
			failNumber = 1,
			isLatest = function (element) {
				//get timestamp element of filename
				var _ts = Number(element.match(/[0-9]{13}/));
				if (_ts === ts) {
					latestFiles.push(element);
				} else if (_ts > ts) {
					latestFiles = [];
					ts = _ts;
					latestFiles.push(element);
				}
			};

		files.forEach(isLatest);

		//open each of the latest files and find failures
		latestFiles.forEach(function (file) {
			var _xml = fs.readFileSync(file),
				xmlDoc = libxmljs.parseXml(_xml),
				fails = xmlDoc.find("./testcase[failure]");
			if (fails.length > 0) {
				grunt.fail.warn(new Error("There were automation testcase failures. Please check build output for more details."))
			}
		});
	})
}