/**
 * This module is a replacement for kraken's 500 error handler.
 * It will log errors to CAL and then render the default 500 template.
 * It is consumed via the application's config/config.json's "serverError" middleware.
 */

'use strict';

var logger = require('./logger');

module.exports = function (template) {

	return function serverError(err, req, res, next) {

		var model = { url: req.url, err: err, statusCode: 500 };

		logger.log(err, req);
		// Wipe out the stack-trace before handing it off to kraken to display
		// We need to do this in the case where it might get back to the client
		err.stack = {};

		if (req.xhr) {
			res.status(500).send(model);
		} else {
			res.status(500);
			res.render(template, model);
		}
	};

};
